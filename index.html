<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma AVA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        /* Custom styles for the active/inactive circle */
        .status-tag .w-3.h-3 {
            flex-shrink: 0; /* Prevent the circle from shrinking */
        }
         /* Custom styles for the settings menu dropdown */
        .settings-menu-container {
            position: relative;
        }
        .settings-menu-container .absolute {
            position: absolute;
            /* Ensure dropdown is above other content */
            z-index: 50; /* Tailwind z-index class */
        }
         /* Hide the file input */
        .hidden-file-input {
            display: none;
        }
        /* Style for the student count circle */
        .student-count-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px; /* Adjust size as needed */
            height: 30px; /* Adjust size as needed */
            /* Background color will be set dynamically by React */
            color: white;
            border-radius: 50%;
            font-size: 0.875rem; /* text-sm */
            font-weight: bold;
            margin-right: 10px; /* Space between circle and title */
            flex-shrink: 0; /* Prevent shrinking */
            transition: background-color 0.3s ease; /* Smooth transition for color change */
        }
        /* Style for the search input container */
        .search-input-container .clear-button {
            position: absolute;
            right: 8px; /* Adjust as needed */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        .search-input-container .clear-button:hover {
            color: #fff;
        }

        /* Full page form container */
        .full-page-form-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Dark overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100; /* Ensure it's on top */
            overflow-y: auto; /* Allow scrolling for smaller screens */
            padding: 20px;
        }

        .full-page-form-container .form-content {
            background: #1a202c; /* bg-gray-900 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 2.5rem; /* p-10 */
            max-width: 800px; /* max-w-2xl */
            width: 100%;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5); /* shadow-lg */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-red-900 text-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
          // State management
          const [students, setStudents] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');
          const [filterStatus, setFilterStatus] = useState('');
          // `editingStudent` will be null for list view, {} for adding, or a student object for editing
          const [editingStudent, setEditingStudent] = useState(null);
          const [isMenuOpen, setIsMenuOpen] = useState(false); // State for menu dropdown visibility

          // Ref for the menu container to detect clicks outside
          const menuRef = useRef(null);
          // Ref for the hidden file input for importing
          const fileInputRef = useRef(null);


          // Form state for adding new students - now managed within the AddEditStudentForm component
          // Moved formData state and resetForm logic to AddEditStudentForm component

          // Load students from localStorage on initial render
          useEffect(() => {
            const savedStudents = JSON.parse(localStorage.getItem('students'));
            if (savedStudents) {
              const updatedStudents = savedStudents.map(student => {
                  const newStudent = { ...student };

                  newStudent.status = Array.isArray(newStudent.status) ? newStudent.status.filter(tag => tag && tag !== '') : [];

                  if (!newStudent.status.some(s => s.startsWith('ativo-'))) {
                      newStudent.status.push('ativo-true');
                  }

                  if (!newStudent.entryDate) {
                      newStudent.entryDate = '';
                  }

                  return newStudent;
              });
              setStudents(updatedStudents.filter(student => student.name && student.course));
            } else {
              const initialStudent = {
                id: crypto.randomUUID(),
                name: "Carlos Santos",
                course: "Administração",
                entryDate: "2025.1",
                status: ["orientation-video", "device-site", "diff-sabe", "ativo-true", "boleto-sabe", "forum-discursiva-sabe", "level-veterano"]
              };
              setStudents([initialStudent]);
            }
          }, []);

          // Save students to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('students', JSON.stringify(students));
          }, [students]);

            // Effect to close menu on outside click
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };

                if (isMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isMenuOpen]);


          // Filter students based on search and filter criteria
          const filteredStudents = students.filter(student => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
            if (!lowerCaseSearchTerm) return true;

            const searchWords = lowerCaseSearchTerm.split(/\s+/).filter(word => word.length > 0);

            const studentSearchableText = `${student.name} ${student.course} ${student.entryDate}`.toLowerCase();

            const matchesSearch = searchWords.every(word => studentSearchableText.includes(word));

            const matchesFilter = filterStatus ?
              student.status.includes(filterStatus) : true;

            return matchesSearch && matchesFilter;
          });

          // Determine the background color class for the student count circle
          const countCircleColorClass = (searchTerm || filterStatus) ? 'bg-yellow-500 text-gray-900' : 'bg-blue-500';


          // Get label for status tag
          const getTagLabel = (tag) => {
            const tagMap = {
              'orientation-video': 'Vídeo Tutorial',
              'orientation-presencial': 'Presencial',
              'device-app': 'App',
              'device-site': 'Site',
              'diff-critico': 'AVA - Crítico',
              'diff-sabe': 'AVA - Sabe',
              'diff-dicas': 'AVA - Dicas',
              'ativo-true': 'Ativo',
              'ativo-false': 'Inativo',
              'boleto-sabe': 'Boleto (Sabe)',
              'boleto-nao-sabe': 'Boleto (Não Sabe)',
              'forum-discursiva-sabe': 'Fórum/Discursiva (Sabe Finalizar)',
              'forum-discursiva-nao-sabe': 'Fórum/Discursiva (Não Sabe Finalizar)',
              'level-veterano': 'Nível: Veterano',
              'level-novato': 'Nível: Novato'
            };
            return tagMap[tag] || tag;
          };

           // Get tag value from label (reverse of getTagLabel)
            const getTagValue = (label) => {
                const tagMap = {
                    'Vídeo Tutorial': 'orientation-video',
                    'Presencial': 'orientation-presencial',
                    'App': 'device-app',
                    'Site': 'site',
                    'AVA - Crítico': 'diff-critico',
                    'AVA - Sabe': 'diff-sabe',
                    'AVA - Dicas': 'diff-dicas',
                    'Ativo': 'ativo-true',
                    'Inativo': 'ativo-false',
                    'Boleto (Sabe)': 'boleto-sabe',
                    'Boleto (Não Sabe)': 'boleto-nao-sabe',
                    'Fórum/Discursiva (Sabe Finalizar)': 'forum-discursiva-sabe',
                    'Fórum/Discursiva (Não Sabe Finalizar)': 'forum-discursiva-nao-sabe',
                    'Nível: Veterano': 'level-veterano',
                    'Nível: Novato': 'level-novato'
                };
                return tagMap[label] || label;
            };


          // Get tag color classes or special rendering for 'ativo' and 'level'
          const getTagColor = (tag) => {
            const colorMap = {
              'orientation-video': 'bg-blue-500',
              'orientation-presencial': 'bg-indigo-500',
              'device-app': 'bg-teal-500',
              'device-site': 'bg-cyan-500',
              'diff-critico': 'bg-red-700 text-white',
              'diff-sabe': 'bg-green-500',
              'diff-dicas': 'bg-yellow-500 text-gray-900',
              'boleto-sabe': 'bg-green-600',
              'boleto-nao-sabe': 'bg-red-600',
              'forum-discursiva-sabe': 'bg-purple-600',
              'forum-discursiva-nao-sabe': 'bg-pink-600',
              'level-veterano': 'bg-green-700',
              'level-novato': 'bg-red-700'
            };
            if (tag.startsWith('ativo-')) {
                return '';
            }
            return colorMap[tag] || 'bg-gray-500';
          };


          // Delete a student
          const deleteStudent = (id) => {
            if (window.confirm('Tem certeza que deseja excluir este aluno?')) {
              setStudents(students.filter(student => student.id !== id));
            }
          };

          // Save a student (add or update)
          const saveStudent = (studentToSave) => {
            if (studentToSave.id) {
              // Update existing student
              setStudents(students.map(s =>
                s.id === studentToSave.id ? studentToSave : s
              ));
            } else {
              // Add new student
              setStudents([...students, { ...studentToSave, id: crypto.randomUUID() }]);
            }
            setEditingStudent(null); // Go back to list view
          };


          // Function to export student data to XLSX
          const exportToXLSX = (data) => {
            const worksheetData = data.map(student => {
              const orientation = getTagLabel(student.status.find(tag => tag.startsWith('orientation-')) || '');
              const device = getTagLabel(student.status.find(tag => tag.startsWith('device-')) || '');
              const difficulty = getTagLabel(student.status.find(tag => tag.startsWith('diff-')) || '');
              const ativo = getTagLabel(student.status.find(tag => tag.startsWith('ativo-')) || '');
              const boleto = getTagLabel(student.status.find(tag => tag.startsWith('boleto-')) || '');
              const forumDiscursiva = getTagLabel(student.status.find(tag => tag.startsWith('forum-discursiva-')) || '');
              const level = getTagLabel(student.status.find(tag => tag.startsWith('level-')) || '');

              return {
                'ID': student.id,
                'Nome do Aluno': student.name,
                'Curso': student.course,
                'Data de Ingresso': student.entryDate,
                'Nível do Aluno': level,
                'Orientação': orientation,
                'Dispositivo': device,
                'Dificuldade AVA': difficulty,
                'Status Ativo': ativo,
                'Emitir Boleto': boleto,
                'Fórum/Discursiva': forumDiscursiva,
              };
            });

            const ws = XLSX.utils.json_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Alunos");

            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const dataBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8' });

            saveAs(dataBlob, 'alunos.xlsx');
          };

          // Function to import student data from XLSX
          const importFromXLSX = (event) => {
            const file = event.target.files[0];
            if (!file) {
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                const jsonStudents = XLSX.utils.sheet_to_json(worksheet);

                const importedStudents = jsonStudents.map(item => {
                    const studentId = crypto.randomUUID();

                    const statusArray = [
                        getTagValue(item['Orientação'] || ''),
                        getTagValue(item['Dispositivo'] || ''),
                        getTagValue(item['Dificuldade AVA'] || ''),
                        getTagValue(item['Status Ativo'] || ''),
                        getTagValue(item['Emitir Boleto'] || ''),
                        getTagValue(item['Fórum/Discursiva'] || ''),
                        getTagValue(item['Nível do Aluno'] || '')
                    ].filter(tag => tag && tag !== '');

                    return {
                        id: studentId,
                        name: item['Nome do Aluno'] || 'Nome Desconhecido',
                        course: item['Curso'] || 'Curso Desconhecido',
                        entryDate: item['Data de Ingresso'] || '',
                        status: statusArray
                    };
                });

                setStudents(importedStudents);
                alert('Dados importados com sucesso!');

              } catch (error) {
                console.error("Error importing file:", error);
                alert('Erro ao importar arquivo. Certifique-se de que é um arquivo XLSX válido e no formato correto.');
              } finally {
                  event.target.value = null;
              }
            };

            reader.readAsArrayBuffer(file);
          };

          // Function to trigger the hidden file input click
          const triggerImport = () => {
            fileInputRef.current.click();
          };

          // Function to clear search term
          const clearSearch = () => {
            setSearchTerm('');
          };

          // Function to clear all student data
          const clearAllStudents = () => {
            if (window.confirm('ATENÇÃO: Tem certeza que deseja APAGAR TODOS os dados de alunos? Esta ação é irreversível.')) {
              setStudents([]);
              localStorage.removeItem('students');
              alert('Todos os dados de alunos foram zerados.');
              setIsMenuOpen(false);
            }
          };

          // Function to update unique IDs for all students and clear local storage
          const updateUniqueIds = () => {
            if (window.confirm('Tem certeza que deseja atualizar os IDs de todos os alunos e limpar o cache da página? Isso pode ser útil para corrigir IDs duplicados ou inválidos e garantir que a aplicação use os dados mais recentes.')) {
              const seenIds = new Set();
              const updatedStudents = students.map(student => {
                let newId = student.id;
                if (typeof newId !== 'string' || seenIds.has(newId)) {
                  newId = crypto.randomUUID();
                }
                seenIds.add(newId);
                return { ...student, id: newId };
              });
              setStudents(updatedStudents);

              localStorage.setItem('students', JSON.stringify(updatedStudents));

              alert('IDs dos alunos atualizados e cache da página limpo com sucesso! A página será recarregada.');
              window.location.reload();
            }
          };


          // Function to check for duplicate students (same name and course)
          const isDuplicateStudent = (currentStudent) => {
            const count = students.filter(student =>
              student.name.toLowerCase() === currentStudent.name.toLowerCase() &&
              currentStudent.course.toLowerCase() === student.course.toLowerCase()
            ).length;
            return count > 1;
          };


          // Student card component with inline editing
          const StudentCard = ({ student, onEdit, onDelete, isDuplicate }) => { // Changed onUpdate to onEdit
            const [editingStatus, setEditingStatus] = useState(null);

            const extractStatusValue = (prefix) => {
              return student.status.find(tag => tag.startsWith(prefix)) || '';
            };

            // Handle inline status change
            const handleInlineStatusChange = (prefix, newValue) => {
                const newStatusArray = student.status.filter(tag => !tag.startsWith(prefix));
                if (newValue) {
                    newStatusArray.push(newValue);
                }

                const updatedStudent = {
                    ...student,
                    status: newStatusArray.filter(tag => tag && tag !== '')
                };
                onEdit(updatedStudent); // Use onEdit to update the student in the main state
                setEditingStatus(null);
            };

            const renderStatusTag = (tag) => {
                const prefix = tag.split('-')[0] + '-';

                if (tag.startsWith('ativo-')) {
                    const isActive = tag === 'ativo-true';
                    const circleColor = isActive ? 'bg-green-500' : 'bg-red-500';
                    const label = isActive ? 'Ativo' : 'Inativo';

                    const toggleActiveStatus = () => {
                        const newStatusValue = isActive ? 'ativo-false' : 'ativo-true';
                        const newStatusArray = student.status.filter(s => !s.startsWith('ativo-'));
                        newStatusArray.push(newStatusValue);
                        const updatedStudent = { ...student, status: newStatusArray };
                        onEdit(updatedStudent); // Use onEdit here too
                    };

                    return (
                        <span
                            key={tag}
                            className="status-tag flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-100 cursor-pointer hover:bg-gray-600 transition-colors"
                            onClick={toggleActiveStatus}
                            title={`Clique para ${isActive ? 'desativar' : 'ativar'}`}
                        >
                            <span className={`w-3 h-3 rounded-full ${circleColor}`}></span>
                            {label}
                        </span>
                    );
                }

                if (editingStatus && editingStatus.prefix === prefix) {
                    let options = [];
                    switch (prefix) {
                        case 'orientation-':
                            options = [
                                { value: 'orientation-video', label: 'Vídeo Tutorial' },
                                { value: 'orientation-presencial', label: 'Presencial' }
                            ];
                            break;
                        case 'device-':
                            options = [
                                { value: 'device-app', label: 'App' },
                                { value: 'device-site', label: 'Site' }
                            ];
                            break;
                        case 'diff-':
                            options = [
                                { value: 'diff-critico', label: 'AVA - Crítico' },
                                { value: 'diff-sabe', label: 'AVA - Sabe' },
                                { value: 'diff-dicas', label: 'AVA - Dicas' }
                            ];
                            break;
                        case 'boleto-':
                            options = [
                                { value: 'boleto-sabe', label: 'Boleto (Sabe)' },
                                { value: 'boleto-nao-sabe', label: 'Boleto (Não Sabe)' }
                            ];
                            break;
                        case 'forum-discursiva-':
                            options = [
                                { value: 'forum-discursiva-sabe', label: 'Fórum/Discursiva (Sabe Finalizar)' },
                                { value: 'forum-discursiva-nao-sabe', label: 'Fórum/Discursiva (Não Sabe Finalizar)' }
                            ];
                            break;
                        case 'level-':
                            options = [
                                { value: 'level-veterano', label: 'Nível: Veterano' },
                                { value: 'level-novato', label: 'Nível: Novato' }
                            ];
                            break;
                        default:
                            options = [];
                    }

                    return (
                         <select
                            key={tag}
                            value={editingStatus.currentValue}
                            onChange={(e) => handleInlineStatusChange(prefix, e.target.value)}
                            onBlur={() => setEditingStatus(null)}
                            className="px-2 py-1 text-sm bg-gray-700 rounded-lg border border-gray-600 text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                            autoFocus
                         >
                            <option value="">Selecione...</option>
                            {options.map(option => (
                                <option key={option.value} value={option.value}>{option.label}</option>
                            ))}
                         </select>
                    );
                } else {
                    return (
                        <span
                            key={tag}
                            className={`status-tag px-3 py-1 rounded-full text-sm font-medium cursor-pointer hover:opacity-80 transition-opacity ${getTagColor(tag)}`}
                            onClick={() => setEditingStatus({ prefix: prefix, currentValue: tag })}
                        >
                            {getTagLabel(tag)}
                        </span>
                    );
                }
            };


            return (
              <div className={`student-card bg-gray-800/70 backdrop-blur-lg rounded-xl p-4 mb-4 relative ${isDuplicate ? 'border-2 border-red-500' : ''}`}>
                <>
                  <div className="student-info">
                    <h3 className="student-name text-xl font-bold text-blue-400 mb-1">
                      {student.name}
                    </h3>
                    <p className="student-course text-gray-400 text-sm">
                      {student.course}
                      {student.entryDate && (
                          <span className="ml-2 text-gray-500 text-xs">({student.entryDate})</span>
                      )}
                    </p>
                  </div>
                  <div className="status-group flex flex-wrap gap-1 mt-2">
                    {student.status.filter(tag => tag.startsWith('ativo-')).map((tag) => (
                        renderStatusTag(tag)
                    ))}
                    {student.status.filter(tag => tag.startsWith('level-')).map((tag) => (
                        renderStatusTag(tag)
                    ))}
                    {student.status.filter(tag => tag.endsWith('-nao-sabe') || tag.startsWith('diff-critico')).map((tag) => (
                        renderStatusTag(tag)
                    ))}
                    {student.status.filter(tag => !tag.startsWith('ativo-') && !tag.startsWith('level-') && !tag.endsWith('-nao-sabe') && !tag.startsWith('diff-critico')).map((tag) => (
                        renderStatusTag(tag)
                    ))}
                  </div>
                  <div className="student-actions absolute top-3 right-3 flex gap-2">
                    <button
                      onClick={() => {
                          console.log("Botão Editar clicado para aluno:", student.id);
                          onEdit(student); // Pass the entire student object for editing
                      }}
                      className="action-btn text-gray-400 hover:text-blue-400 transition-colors"
                      title="Editar"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button
                      onClick={() => onDelete(student.id)}
                      className="action-btn text-gray-400 hover:text-red-400 transition-colors"
                      title="Excluir"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                      </svg>
                    </button>
                  </div>
                </>
              </div>
            );
          };

          // New component for Add/Edit Student Form
          const AddEditStudentForm = ({ studentToEdit, onSave, onCancel, getTagValue }) => {
            const [formData, setFormData] = useState({
              name: '',
              course: '',
              entryDate: '',
              level: '',
              orientation: '',
              device: '',
              difficulty: '',
              ativo: 'ativo-true',
              boleto: '',
              forumDiscursiva: ''
            });

            useEffect(() => {
              console.log("Rendering AddEditStudentForm, studentToEdit:", studentToEdit);
              if (studentToEdit && studentToEdit.id) { // Editing existing student
                const extractStatus = (prefix) => studentToEdit.status.find(tag => tag.startsWith(prefix)) || '';
                setFormData({
                  name: studentToEdit.name,
                  course: studentToEdit.course,
                  entryDate: studentToEdit.entryDate,
                  level: extractStatus('level-'),
                  orientation: extractStatus('orientation-'),
                  device: extractStatus('device-'),
                  difficulty: extractStatus('diff-'),
                  ativo: extractStatus('ativo-'),
                  boleto: extractStatus('boleto-'),
                  forumDiscursiva: extractStatus('forum-discursiva-')
                });
              } else { // Adding new student or no student to edit
                setFormData({
                  name: '',
                  course: '',
                  entryDate: '',
                  level: '',
                  orientation: '',
                  device: '',
                  difficulty: '',
                  ativo: 'ativo-true',
                  boleto: '',
                  forumDiscursiva: ''
                });
              }
            }, [studentToEdit]);

            const handleSubmit = () => {
              if (!formData.name || !formData.course) {
                alert('Por favor, preencha o Nome do Aluno e o Curso.');
                return;
              }

              const newStatus = [
                  formData.orientation,
                  formData.device,
                  formData.difficulty,
                  formData.ativo || 'ativo-true',
                  formData.boleto,
                  formData.forumDiscursiva,
                  formData.level
              ].filter(tag => tag && tag !== '');

              const studentData = {
                id: studentToEdit ? studentToEdit.id : undefined, // Keep ID if editing, undefined if new
                name: formData.name,
                course: formData.course,
                entryDate: formData.entryDate,
                status: newStatus
              };
              onSave(studentData);
            };

            return (
              <div className="full-page-form-container">
                <div className="form-content">
                  <h1 className="text-2xl font-bold text-blue-400 mb-4">
                    {studentToEdit && studentToEdit.id ? 'Editar Aluno' : 'Adicionar Novo Aluno'}
                  </h1>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">Nome <span className="text-red-500">*</span></label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Curso <span className="text-red-500">*</span></label>
                      <input
                        type="text"
                        value={formData.course}
                        onChange={(e) => setFormData({...formData, course: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Data de Ingresso (Ex: 2025.1)</label>
                      <input
                        type="text"
                        value={formData.entryDate}
                        onChange={(e) => setFormData({...formData, entryDate: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        placeholder="Ex: 2025.1"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Nível do Aluno</label>
                      <select
                        value={formData.level}
                        onChange={(e) => setFormData({...formData, level: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                      >
                        <option value="">Selecione...</option>
                        <option value="level-veterano">Veterano</option>
                        <option value="level-novato">Novato</option>
                      </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div>
                        <label className="block text-sm font-medium mb-1">Orientação</label>
                        <select
                          value={formData.orientation}
                          onChange={(e) => setFormData({...formData, orientation: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="orientation-video">Vídeo Tutorial</option>
                          <option value="orientation-presencial">Presencial</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Dispositivo</label>
                        <select
                          value={formData.device}
                          onChange={(e) => setFormData({...formData, device: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="device-app">App</option>
                          <option value="device-site">Site</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Dificuldade</label>
                        <select
                          value={formData.difficulty}
                          onChange={(e) => setFormData({...formData, difficulty: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="diff-critico">AVA - Crítico</option>
                          <option value="diff-sabe">AVA - Sabe</option>
                          <option value="diff-dicas">AVA - Dicas</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Status Ativo</label>
                        <select
                          value={formData.ativo}
                          onChange={(e) => setFormData({...formData, ativo: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="ativo-true">Ativo</option>
                          <option value="ativo-false">Inativo</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Emitir Boleto</label>
                        <select
                          value={formData.boleto}
                          onChange={(e) => setFormData({...formData, boleto: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="boleto-sabe">Sabe</option>
                          <option value="boleto-nao-sabe">Não Sabe</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Fórum/Discursiva</label>
                        <select
                          value={formData.forumDiscursiva}
                          onChange={(e) => setFormData({...formData, forumDiscursiva: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                          <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                        </select>
                      </div>
                    </div>
                    <div className="flex gap-3 pt-2">
                      <button
                        onClick={handleSubmit}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-white"
                      >
                        Salvar
                      </button>
                      <button
                        onClick={onCancel}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors text-white"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };


          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-red-900 text-gray-100">
              {/* Debugging log for editingStudent state */}
              {console.log('App renderizado, editingStudent:', editingStudent)}
              {/* Navigation */}
              <nav className="navbar sticky top-0 z-10 flex justify-between items-center p-4 bg-black/50 backdrop-blur-md">
                {/* Container for the count circle and title */}
                <div className="flex items-center">
                    {/* Student Count Circle - Displays count of filtered students and changes color */}
                    <div className={`student-count-circle ${countCircleColorClass}`}>
                        {filteredStudents.length}
                    </div>
                    <div className="logo text-2xl font-bold text-blue-400">Plataforma AVA</div>
                </div>
                {/* Settings menu with icon and dropdown */}
                <div className="settings-menu-container relative" ref={menuRef}> {/* Add ref and class */}
                    <button
                        onClick={() => setIsMenuOpen(!isMenuOpen)}
                        className="settings-button text-gray-300 hover:text-blue-400 transition-colors focus:outline-none"
                        aria-label="Menu de Configurações"
                    >
                        {/* Settings Icon (Feather Icons) */}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-settings">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67l-.2.2c-.39.39-.66 1.11-.66 1.67V21h-3.73a1.65 1.65 0 0 0-1.65-1.65h-.79a1.65 1.65 0 0 0-1.65 1.65H3v-3.73a1.65 1.65 0 0 0-.66-1.67l-.2-.2a1.65 1.65 0 0 0 .3-1.67l-.2-.2c.39-.39 1.11-.66 1.67-.66H3v-3.73a1.65 1.65 0 0 0 1.65-1.65v-.79a1.65 1.65 0 0 0-1.65-1.65H3V3h3.73a1.65 1.65 0 0 0 1.65 1.65h.79a1.65 1.65 0 0 0 1.65-1.65H21v3.73c.56 0 1.3.27 1.67.66l.2.2a1.65 1.65 0 0 0 0 2.34l-.2.2c-.39.39-1.11.66-1.67.66z"></path>
                        </svg>
                    </button>
                    {/* Dropdown Menu */}
                    {isMenuOpen && (
                      <div className="absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-20">
                        {/* Menu Item: Configurações */}
                        <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                alert('Funcionalidade de Configurações (em desenvolvimento)'); // Placeholder action
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Configurações
                        </a>
                        {/* Menu Item: Exportar para XLSX */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                exportToXLSX(students); // Call the export function
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Exportar para XLSX
                        </a>
                        {/* Menu Item: Importar de XLSX */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                triggerImport(); // Trigger the file input click
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Importar de XLSX
                        </a>
                        {/* New Menu Item: Gestão de Materiais Didáticos */}
                         <a
                            href="https://fbiluoficial.github.io/uninta-disciplina/" // Set the href
                            target="_blank" // Open in a new tab
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Gestão de Materiais Didáticos
                        </a>
                        {/* New Menu Item: Atualizar IDs Únicos */}
                        <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={updateUniqueIds} // Call the new function
                        >
                            Atualizar IDs Únicos
                        </a>
                        {/* New Menu Item: Zerar Todos */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700"
                            onClick={clearAllStudents} // Call the clearAllStudents function
                        >
                            Zerar Todos
                        </a>
                      </div>
                    )}
                </div>
              </nav>

              {/* Hidden file input for import */}
              <input
                type="file"
                ref={fileInputRef}
                onChange={importFromXLSX}
                accept=".xlsx"
                className="hidden-file-input"
              />


              {/* Main Content */}
              <main className="container mx-auto px-4 py-8">
                {/* Filters */}
                <div className="filters flex flex-wrap gap-4 mb-8">
                  <div className="flex-grow min-w-[200px] search-input-container"> {/* Added search-input-container class */}
                    <input
                      type="text"
                      placeholder="Buscar aluno..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="search-input w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white placeholder-gray-400 pr-10" /* Added pr-10 for button space */
                    />
                    {searchTerm && ( /* Conditionally render clear button */
                        <button
                            onClick={clearSearch}
                            className="clear-button"
                            aria-label="Limpar busca"
                        >
                            &times; {/* HTML entity for 'x' */}
                        </button>
                    )}
                  </div>
                  <div className="min-w-[200px]">
                    <select
                      value={filterStatus}
                      onChange={(e) => setFilterStatus(e.target.value)}
                      className="filter-select w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white"
                    >
                      <option value="">Filtrar por status...</option>
                      <option value="orientation-video">Vídeo Tutorial</option>
                      <option value="orientation-presencial">Presencial</option>
                      <option value="device-app">App</option>
                      <option value="device-site">Site</option>
                      <option value="diff-critico">AVA - Crítico</option>
                      <option value="diff-sabe">AVA - Sabe</option>
                      <option value="diff-dicas">AVA - Dicas</option>
                      <option value="ativo-true">Ativo</option>
                      <option value="ativo-false">Inativo</option>
                      <option value="boleto-sabe">Boleto (Sabe)</option>
                      <option value="boleto-nao-sabe">Boleto (Não Sabe)</option>
                      <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                      <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                       <option value="level-veterano">Nível: Veterano</option> {/* New filter option */}
                       <option value="level-novato">Nível: Novato</option> {/* New filter option */}
                    </select>
                  </div>
                </div>

                {/* Student List */}
                <div className="students-container">
                  {filteredStudents.length > 0 && (
                    filteredStudents.map(student => (
                      <StudentCard
                        key={student.id}
                        student={student}
                        onEdit={setEditingStudent} // Corrected: Pass setEditingStudent directly
                        onDelete={deleteStudent}
                        isDuplicate={isDuplicateStudent(student)}
                      />
                    ))
                  )}
                </div>
              </main>

              {/* Add/Edit Student Form (Full Page) */}
              {editingStudent !== null && (
                <AddEditStudentForm
                  studentToEdit={editingStudent}
                  onSave={saveStudent}
                  onCancel={() => setEditingStudent(null)}
                  getTagValue={getTagValue} // Pass getTagValue to the form for status handling
                />
              )}

              {/* Floating Action Button */}
              {editingStudent === null && ( // Only show FAB if not adding/editing
                <button
                  onClick={() => {
                      console.log("FAB clicado, definindo editingStudent para objeto vazio");
                      setEditingStudent({}); // Set to empty object for new student
                  }}
                  className="fab fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-colors focus:outline-none z-50"
                  aria-label="Adicionar aluno"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              )}
            </div>
          );
        }

        // Render the App component into the root div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
