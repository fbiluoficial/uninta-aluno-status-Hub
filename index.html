<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma AVA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        /* Custom styles for the active/inactive circle */
        .status-tag .w-3.h-3 {
            flex-shrink: 0; /* Prevent the circle from shrinking */
        }
         /* Custom styles for the settings menu dropdown */
        .settings-menu-container {
            position: relative;
        }
        .settings-menu-container .absolute {
            position: absolute;
            /* Ensure dropdown is above other content */
            z-index: 50; /* Tailwind z-index class */
        }
         /* Hide the file input */
        .hidden-file-input {
            display: none;
        }
        /* Style for the student count circle */
        .student-count-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px; /* Adjust size as needed */
            height: 30px; /* Adjust size as needed */
            /* Background color will be set dynamically by React */
            color: white;
            border-radius: 50%;
            font-size: 0.875rem; /* text-sm */
            font-weight: bold;
            margin-right: 10px; /* Space between circle and title */
            flex-shrink: 0; /* Prevent shrinking */
            transition: background-color 0.3s ease; /* Smooth transition for color change */
        }
        /* Style for the search input container */
        .search-input-container .clear-button {
            position: absolute;
            right: 8px; /* Adjust as needed */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        .search-input-container .clear-button:hover {
            color: #fff;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-red-900 text-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
          // State management
          const [students, setStudents] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');
          const [filterStatus, setFilterStatus] = useState('');
          const [isAdding, setIsAdding] = useState(false);
          const [isMenuOpen, setIsMenuOpen] = useState(false); // State for menu dropdown visibility

          // Ref for the menu container to detect clicks outside
          const menuRef = useRef(null);
          // Ref for the hidden file input for importing
          const fileInputRef = useRef(null);


          // Form state for adding new students
          const [formData, setFormData] = useState({
            name: '',
            course: '',
            entryDate: '', // Field for entry date
            level: '', // New field for student level
            orientation: '',
            device: '',
            difficulty: '',
            ativo: 'ativo-true', // Default new students to active
            boleto: '',
            forumDiscursiva: ''
          });

          // Load students from localStorage on initial render
          useEffect(() => {
            const savedStudents = JSON.parse(localStorage.getItem('students'));
            if (savedStudents) {
              // Ensure loaded students have default statuses and entryDate if missing
              // IMPORTANT FIX: Create a new object for each student to avoid shared references
              const updatedStudents = savedStudents.map(student => {
                  const newStudent = { ...student }; // Create a new student object

                  // Ensure status array exists and filter out empty strings
                  newStudent.status = Array.isArray(newStudent.status) ? newStudent.status.filter(tag => tag && tag !== '') : [];

                  // Add default 'ativo' status if missing
                  if (!newStudent.status.some(s => s.startsWith('ativo-'))) {
                      newStudent.status.push('ativo-true');
                  }

                   // Ensure entryDate exists
                  if (!newStudent.entryDate) {
                      newStudent.entryDate = '';
                  }

                  return newStudent; // Return the new object
              });
              setStudents(updatedStudents.filter(student => student.name && student.course)); // Filter out students without name or course on load
            } else {
              // Initial sample student with all fields
              const initialStudent = {
                id: crypto.randomUUID(), // Changed to use crypto.randomUUID()
                name: "Carlos Santos",
                course: "Administração",
                entryDate: "2025.1", // Sample entry date
                status: ["orientation-video", "device-site", "diff-sabe", "ativo-true", "boleto-sabe", "forum-discursiva-sabe", "level-veterano"] // Sample level status
              };
              setStudents([initialStudent]);
            }
          }, []); // Empty dependency array means this runs only once on mount

          // Save students to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('students', JSON.stringify(students));
          }, [students]);

            // Effect to close menu on outside click
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };

                if (isMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isMenuOpen]);


          // Filter students based on search and filter criteria
          const filteredStudents = students.filter(student => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
            if (!lowerCaseSearchTerm) return true; // If search term is empty, show all students

            // Split the search term into individual words
            const searchWords = lowerCaseSearchTerm.split(/\s+/).filter(word => word.length > 0);

            // Create a single searchable string from student data
            const studentSearchableText = `${student.name} ${student.course} ${student.entryDate}`.toLowerCase();

            // Check if all search words are included in the student's searchable text
            const matchesSearch = searchWords.every(word => studentSearchableText.includes(word));

            const matchesFilter = filterStatus ?
              student.status.includes(filterStatus) : true;

            return matchesSearch && matchesFilter;
          });

          // Determine the background color class for the student count circle
          const countCircleColorClass = (searchTerm || filterStatus) ? 'bg-yellow-500 text-gray-900' : 'bg-blue-500';


          // Get label for status tag
          const getTagLabel = (tag) => {
            const tagMap = {
              'orientation-video': 'Vídeo Tutorial',
              'orientation-presencial': 'Presencial',
              'device-app': 'App',
              'device-site': 'Site',
              'diff-critico': 'AVA - Crítico',
              'diff-sabe': 'AVA - Sabe',
              'diff-dicas': 'AVA - Dicas',
              'ativo-true': 'Ativo',
              'ativo-false': 'Inativo',
              'boleto-sabe': 'Boleto (Sabe)',
              'boleto-nao-sabe': 'Boleto (Não Sabe)',
              'forum-discursiva-sabe': 'Fórum/Discursiva (Sabe Finalizar)',
              'forum-discursiva-nao-sabe': 'Fórum/Discursiva (Não Sabe Finalizar)',
              'level-veterano': 'Nível: Veterano', // New label
              'level-novato': 'Nível: Novato' // New label
            };
            return tagMap[tag] || tag;
          };

           // Get tag value from label (reverse of getTagLabel)
            const getTagValue = (label) => {
                const tagMap = {
                    'Vídeo Tutorial': 'orientation-video',
                    'Presencial': 'orientation-presencial',
                    'App': 'device-app',
                    'Site': 'site',
                    'AVA - Crítico': 'diff-critico',
                    'AVA - Sabe': 'diff-sabe',
                    'AVA - Dicas': 'diff-dicas',
                    'Ativo': 'ativo-true',
                    'Inativo': 'ativo-false',
                    'Boleto (Sabe)': 'boleto-sabe',
                    'Boleto (Não Sabe)': 'boleto-nao-sabe',
                    'Fórum/Discursiva (Sabe Finalizar)': 'forum-discursiva-sabe',
                    'Fórum/Discursiva (Não Sabe Finalizar)': 'forum-discursiva-nao-sabe',
                    'Nível: Veterano': 'level-veterano',
                    'Nível: Novato': 'level-novato'
                };
                return tagMap[label] || label; // Return original label if not found
            };


          // Get tag color classes or special rendering for 'ativo' and 'level'
          const getTagColor = (tag) => {
            const colorMap = {
              'orientation-video': 'bg-blue-500',
              'orientation-presencial': 'bg-indigo-500',
              'device-app': 'bg-teal-500',
              'device-site': 'bg-cyan-500',
              'diff-critico': 'bg-red-700 text-white',
              'diff-sabe': 'bg-green-500',
              'diff-dicas': 'bg-yellow-500 text-gray-900',
              'boleto-sabe': 'bg-green-600',
              'boleto-nao-sabe': 'bg-red-600',
              'forum-discursiva-sabe': 'bg-purple-600',
              'forum-discursiva-nao-sabe': 'bg-pink-600',
              'level-veterano': 'bg-green-700', // Green for Veterano
              'level-novato': 'bg-red-700' // Red for Novato
            };
            // Special handling for 'ativo' status to render a circle
            if (tag.startsWith('ativo-')) {
                return ''; // No background color class needed, will render a circle
            }
            return colorMap[tag] || 'bg-gray-500'; // Default gray for unknown/empty tags (should not happen with filtering)
          };


          // Delete a student
          const deleteStudent = (id) => {
            if (window.confirm('Tem certeza que deseja excluir este aluno?')) {
              setStudents(students.filter(student => student.id !== id));
            }
          };

          // Add a new student - UPDATED VALIDATION and fields
          const addStudent = () => {
            // Only validate Name and Course
            if (!formData.name || !formData.course) {
              alert('Por favor, preencha o Nome do Aluno e o Curso.');
              return;
            }

            const newStudent = {
              id: crypto.randomUUID(), // Changed to use crypto.randomUUID()
              name: formData.name,
              course: formData.course,
              entryDate: formData.entryDate, // Include entryDate
              // Combine all selected statuses into the status array, filter out empty
              status: [
                  formData.orientation,
                  formData.device,
                  formData.difficulty,
                  formData.ativo || 'ativo-true', // Default to active if empty
                  formData.boleto,
                  formData.forumDiscursiva,
                  formData.level
              ].filter(tag => tag && tag !== '') // Filter out null, undefined, and empty strings
            };

            setStudents([...students, newStudent]);
            setIsAdding(false);
            resetForm();
          };

          // Reset form fields - UPDATED (reset to default new options, entryDate, and level)
          const resetForm = () => {
            setFormData({
              name: '',
              course: '',
              entryDate: '',
              level: '', // Reset level
              orientation: '',
              device: '',
              difficulty: '',
              ativo: 'ativo-true', // Reset to active
              boleto: '',
              forumDiscursiva: ''
            });
          };

          // Function to export student data to XLSX
          const exportToXLSX = (data) => {
            // Map student data to a flat structure for the spreadsheet
            const worksheetData = data.map(student => {
              // Extract individual status values using getTagLabel for readability
              const orientation = getTagLabel(student.status.find(tag => tag.startsWith('orientation-')) || '');
              const device = getTagLabel(student.status.find(tag => tag.startsWith('device-')) || '');
              const difficulty = getTagLabel(student.status.find(tag => tag.startsWith('diff-')) || '');
              const ativo = getTagLabel(student.status.find(tag => tag.startsWith('ativo-')) || '');
              const boleto = getTagLabel(student.status.find(tag => tag.startsWith('boleto-')) || '');
              const forumDiscursiva = getTagLabel(student.status.find(tag => tag.startsWith('forum-discursiva-')) || '');
              const level = getTagLabel(student.status.find(tag => tag.startsWith('level-')) || ''); // Extract new level

              return {
                'ID': student.id,
                'Nome do Aluno': student.name,
                'Curso': student.course,
                'Data de Ingresso': student.entryDate, // Include entryDate
                'Nível do Aluno': level, // Include new level column
                'Orientação': orientation,
                'Dispositivo': device,
                'Dificuldade AVA': difficulty,
                'Status Ativo': ativo,
                'Emitir Boleto': boleto,
                'Fórum/Discursiva': forumDiscursiva,
              };
            });

            // Create a worksheet from the data using the global XLSX object
            const ws = XLSX.utils.json_to_sheet(worksheetData);
            // Create a new workbook and add the worksheet using the global XLSX object
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Alunos"); // Sheet name is "Alunos"

            // Write the workbook to a binary string using the global XLSX object
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            // Create a Blob from the buffer using the global Blob object
            const dataBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8' });

            // Save the file using the global saveAs function from FileSaver
            saveAs(dataBlob, 'alunos.xlsx'); // File name is "alunos.xlsx"
          };

          // Function to import student data from XLSX
          const importFromXLSX = (event) => {
            const file = event.target.files[0];
            if (!file) {
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assuming the first sheet contains the student data
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                // Convert worksheet to JSON array
                const jsonStudents = XLSX.utils.sheet_to_json(worksheet);

                // Map JSON data back to student object structure
                const importedStudents = jsonStudents.map(item => {
                    // Always generate a new unique ID for imported students
                    const studentId = crypto.randomUUID();

                    // Reconstruct the status array from the imported columns, filtering out empty
                    const statusArray = [
                        getTagValue(item['Orientação'] || ''),
                        getTagValue(item['Dispositivo'] || ''),
                        getTagValue(item['Dificuldade AVA'] || ''),
                        getTagValue(item['Status Ativo'] || ''),
                        getTagValue(item['Emitir Boleto'] || ''),
                        getTagValue(item['Fórum/Discursiva'] || ''),
                        getTagValue(item['Nível do Aluno'] || '') // Include new level
                    ].filter(tag => tag && tag !== ''); // Filter out null, undefined, and empty strings

                    return {
                        id: studentId, // Use the newly generated unique ID
                        name: item['Nome do Aluno'] || 'Nome Desconhecido',
                        course: item['Curso'] || 'Curso Desconhecido',
                        entryDate: item['Data de Ingresso'] || '', // Include entryDate
                        status: statusArray
                    };
                });

                // Update the students state with the imported data
                setStudents(importedStudents);
                alert('Dados importados com sucesso!'); // Success message

              } catch (error) {
                console.error("Error importing file:", error);
                alert('Erro ao importar arquivo. Certifique-se de que é um arquivo XLSX válido e no formato correto.'); // Error message
              } finally {
                  // Clear the file input value to allow importing the same file again
                  event.target.value = null;
              }
            };

            reader.readAsArrayBuffer(file);
          };

          // Function to trigger the hidden file input click
          const triggerImport = () => {
            fileInputRef.current.click();
          };

          // Function to clear search term
          const clearSearch = () => {
            setSearchTerm('');
          };

          // Function to clear all student data
          const clearAllStudents = () => {
            if (window.confirm('ATENÇÃO: Tem certeza que deseja APAGAR TODOS os dados de alunos? Esta ação é irreversível.')) {
              setStudents([]); // Clear the students array in state
              localStorage.removeItem('students'); // Clear data from localStorage
              alert('Todos os dados de alunos foram zerados.'); // Confirmation message
              setIsMenuOpen(false); // Close menu after action
            }
          };

          // Function to update unique IDs for all students
          const updateUniqueIds = () => {
            if (window.confirm('Tem certeza que deseja atualizar os IDs de todos os alunos? Isso pode ser útil para corrigir IDs duplicados ou inválidos.')) {
              const seenIds = new Set();
              const updatedStudents = students.map(student => {
                let newId = student.id;
                // Check if ID is not a string (e.g., old number timestamp) or if it's a duplicate
                if (typeof newId !== 'string' || seenIds.has(newId)) {
                  newId = crypto.randomUUID();
                }
                seenIds.add(newId);
                return { ...student, id: newId };
              });
              setStudents(updatedStudents);
              alert('IDs dos alunos atualizados com sucesso!');
              setIsMenuOpen(false); // Close menu after action
            }
          };


          // Function to check for duplicate students (same name and course)
          const isDuplicateStudent = (currentStudent) => {
            // Count occurrences of the current student's name and course combination
            const count = students.filter(student =>
              student.name.toLowerCase() === currentStudent.name.toLowerCase() &&
              student.course.toLowerCase() === currentStudent.course.toLowerCase()
            ).length;
            // If count is greater than 1, it means there are duplicates (including itself)
            return count > 1;
          };


          // Student card component with inline editing
          const StudentCard = ({ student, onUpdate, onDelete, isDuplicate }) => { // Added isDuplicate prop
            const [isEditing, setIsEditing] = useState(false);
            // State to hold the student data being edited in the main form
            const [editedStudent, setEditedStudent] = useState({ ...student });
            // State to track which status tag is being edited inline { prefix: string, currentValue: string }
            const [editingStatus, setEditingStatus] = useState(null);

            // Helper to extract specific status value by prefix
            const extractStatusValue = (prefix) => {
              return student.status.find(tag => tag.startsWith(prefix)) || '';
            };

            // Initialize edited student state when student prop changes or editing starts
            useEffect(() => {
              if (isEditing) { // Only update editedStudent when entering edit mode
                setEditedStudent({
                  ...student, // Spreading the original student prop
                  orientation: extractStatusValue('orientation-'),
                  device: extractStatusValue('device-'),
                  difficulty: extractStatusValue('diff-'),
                  ativo: extractStatusValue('ativo-'),
                  boleto: extractStatusValue('boleto-'),
                  forumDiscursiva: extractStatusValue('forum-discursiva-'),
                  level: extractStatusValue('level-') // Extract new level
                });
              } else { // When exiting edit mode, reset editedStudent to match the current student prop
                   setEditedStudent({ ...student });
              }
            }, [student, isEditing]); // Depend on student and isEditing state


            // Handle save of edited student (for the main edit form) - UPDATED VALIDATION and fields
            const handleSave = () => {
               // Only validate Name and Course
                if (!editedStudent.name || !editedStudent.course) {
                    alert('Por favor, preencha o Nome do Aluno e o Curso.');
                    return;
                }

              // Filter out old status values by their prefixes
              const newStatus = student.status.filter(
                tag => !['orientation-', 'device-', 'diff-', 'ativo-', 'boleto-', 'forum-discursiva-', 'level-'].some(prefix => tag.startsWith(prefix)) // Include new prefix
              );

              // Add updated status values from the edited form state, filter out empty
              if (editedStudent.orientation) newStatus.push(editedStudent.orientation);
              if (editedStudent.device) newStatus.push(editedStudent.device);
              if (editedStudent.difficulty) newStatus.push(editedStudent.difficulty);
              if (editedStudent.ativo) newStatus.push(editedStudent.ativo);
              if (editedStudent.boleto) newStatus.push(editedStudent.boleto);
              if (editedStudent.forumDiscursiva) newStatus.push(editedStudent.forumDiscursiva);
              if (editedStudent.level) newStatus.push(editedStudent.level); // Include new level


              // Create the updated student object
              const updatedStudent = {
                ...editedStudent,
                status: newStatus.filter(tag => tag && tag !== '') // Filter out null, undefined, and empty strings
              };

              // Call the parent update function
              onUpdate(updatedStudent);
              // Exit edit mode
              setIsEditing(false);
            };

            // Handle inline status change - UPDATED to include level
            const handleInlineStatusChange = (prefix, newValue) => {
                // Find the old tag with the given prefix
                const oldTag = student.status.find(tag => tag.startsWith(prefix));
                // Filter out the old tag and add the new one
                const newStatusArray = student.status.filter(tag => !tag.startsWith(prefix));
                if (newValue) { // Only add if a value is selected
                    newStatusArray.push(newValue);
                }

                const updatedStudent = {
                    ...student,
                    status: newStatusArray.filter(tag => tag && tag !== '') // Filter out null, undefined, and empty strings
                };
                onUpdate(updatedStudent); // Update the parent state
                setEditingStatus(null); // Close the inline editor
            };

            // Render status tag, with special handling for 'ativo' and inline editing - UPDATED (options for inline select and order)
            const renderStatusTag = (tag) => { // Removed index, using tag as key
                const prefix = tag.split('-')[0] + '-'; // Get the prefix (e.g., 'orientation-', 'boleto-', 'level-')

                // Handle 'ativo' status toggle
                if (tag.startsWith('ativo-')) {
                    const isActive = tag === 'ativo-true';
                    const circleColor = isActive ? 'bg-green-500' : 'bg-red-500';
                    const label = isActive ? 'Ativo' : 'Inativo';

                    const toggleActiveStatus = () => {
                        const newStatusValue = isActive ? 'ativo-false' : 'ativo-true';
                        const newStatusArray = student.status.filter(s => !s.startsWith('ativo-'));
                        newStatusArray.push(newStatusValue);
                        const updatedStudent = { ...student, status: newStatusArray };
                        onUpdate(updatedStudent);
                    };

                    return (
                        <span
                            key={tag} // Changed key to tag
                            className="status-tag flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-100 cursor-pointer hover:bg-gray-600 transition-colors"
                            onClick={toggleActiveStatus}
                            title={`Clique para ${isActive ? 'desativar' : 'ativar'}`}
                        >
                            <span className={`w-3 h-3 rounded-full ${circleColor}`}></span>
                            {label}
                        </span>
                    );
                }

                // Handle inline editing for other statuses
                if (editingStatus && editingStatus.prefix === prefix) {
                    // Render a select dropdown for editing
                    let options = [];
                    switch (prefix) {
                        case 'orientation-':
                            options = [
                                { value: 'orientation-video', label: 'Vídeo Tutorial' },
                                { value: 'orientation-presencial', label: 'Presencial' }
                            ];
                            break;
                        case 'device-':
                            options = [
                                { value: 'device-app', label: 'App' },
                                { value: 'device-site', label: 'Site' }
                            ];
                            break;
                        case 'diff-':
                            options = [
                                { value: 'diff-critico', label: 'AVA - Crítico' },
                                { value: 'diff-sabe', label: 'AVA - Sabe' },
                                { value: 'diff-dicas', label: 'AVA - Dicas' }
                            ];
                            break;
                        case 'boleto-':
                            options = [
                                { value: 'boleto-sabe', label: 'Boleto (Sabe)' },
                                { value: 'boleto-nao-sabe', label: 'Boleto (Não Sabe)' }
                            ];
                            break;
                        case 'forum-discursiva-':
                            options = [
                                { value: 'forum-discursiva-sabe', label: 'Fórum/Discursiva (Sabe Finalizar)' },
                                { value: 'forum-discursiva-nao-sabe', label: 'Fórum/Discursiva (Não Sabe Finalizar)' }
                            ];
                            break;
                        case 'level-': // New case for level status
                            options = [
                                { value: 'level-veterano', label: 'Nível: Veterano' },
                                { value: 'level-novato', label: 'Nível: Novato' }
                            ];
                            break;
                        default:
                            options = [];
                    }

                    return (
                         <select
                            key={tag} // Changed key to tag
                            value={editingStatus.currentValue}
                            onChange={(e) => handleInlineStatusChange(prefix, e.target.value)}
                            onBlur={() => setEditingStatus(null)} // Close on blur
                            className="px-2 py-1 text-sm bg-gray-700 rounded-lg border border-gray-600 text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                            autoFocus // Auto focus the select when it appears
                         >
                            <option value="">Selecione...</option> {/* Option to clear status */}
                            {options.map(option => (
                                <option key={option.value} value={option.value}>{option.label}</option>
                            ))}
                         </select>
                    );
                } else {
                    // Render static tag for other statuses, make them clickable to start inline edit
                    return (
                        <span
                            key={tag} // Changed key to tag
                            className={`status-tag px-3 py-1 rounded-full text-sm font-medium cursor-pointer hover:opacity-80 transition-opacity ${getTagColor(tag)}`}
                            onClick={() => setEditingStatus({ prefix: prefix, currentValue: tag })} // Set editing state on click
                        >
                            {getTagLabel(tag)}
                        </span>
                    );
                }
            };


            return (
              // Adjusted padding and margin for compactness
              // Added conditional styling for duplicate students
              <div className={`student-card bg-gray-800/70 backdrop-blur-lg rounded-xl p-4 mb-4 relative ${isDuplicate ? 'border-2 border-red-500' : ''}`}>
                {isEditing ? (
                  // Adjusted spacing in edit form
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">Nome <span className="text-red-500">*</span></label> {/* Indicate required field */}
                      <input
                        type="text"
                        value={editedStudent.name}
                        onChange={(e) => setEditedStudent({...editedStudent, name: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        required // Add required attribute for browser-level validation
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Curso <span className="text-red-500">*</span></label> {/* Indicate required field */}
                      <input
                        type="text"
                        value={editedStudent.course}
                        onChange={(e) => setEditedStudent({...editedStudent, course: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        required // Add required attribute
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Data de Ingresso (Ex: 2025.1)</label> {/* New field */}
                      <input
                        type="text"
                        value={editedStudent.entryDate}
                        onChange={(e) => setEditedStudent({...editedStudent, entryDate: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        placeholder="Ex: 2025.1"
                      />
                    </div>
                     {/* New Level Field */}
                    <div>
                      <label className="block text-sm font-medium mb-1">Nível do Aluno</label> {/* New field */}
                      <select
                        value={editedStudent.level}
                        onChange={(e) => setEditedStudent({...editedStudent, level: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                      >
                        <option value="">Selecione...</option>
                        <option value="level-veterano">Veterano</option>
                        <option value="level-novato">Novato</option>
                      </select>
                    </div>
                    {/* Adjusted gap in the grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div>
                        <label className="block text-sm font-medium mb-1">Orientação</label>
                        <select
                          value={editedStudent.orientation}
                          onChange={(e) => setEditedStudent({...editedStudent, orientation: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="orientation-video">Vídeo Tutorial</option>
                          <option value="orientation-presencial">Presencial</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Dispositivo</label>
                        <select
                          value={editedStudent.device}
                          onChange={(e) => setEditedStudent({...editedStudent, device: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="device-app">App</option>
                          <option value="device-site">Site</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Dificuldade</label>
                        <select
                          value={editedStudent.difficulty}
                          onChange={(e) => setEditedStudent({...editedStudent, difficulty: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="diff-critico">AVA - Crítico</option>
                          <option value="diff-sabe">AVA - Sabe</option>
                          <option value="diff-dicas">AVA - Dicas</option>
                        </select>
                      </div>
                       {/* New Status Fields */}
                       <div>
                        <label className="block text-sm font-medium mb-1">Status Ativo</label>
                        <select
                          value={editedStudent.ativo}
                          onChange={(e) => setEditedStudent({...editedStudent, ativo: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="ativo-true">Ativo</option>
                          <option value="ativo-false">Inativo</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Emitir Boleto</label>
                        <select
                          value={editedStudent.boleto}
                          onChange={(e) => setEditedStudent({...editedStudent, boleto: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="boleto-sabe">Sabe</option>
                          <option value="boleto-nao-sabe">Não Sabe</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Fórum/Discursiva</label>
                        <select
                          value={editedStudent.forumDiscursiva}
                          onChange={(e) => setEditedStudent({...editedStudent, forumDiscursiva: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                          <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                        </select>
                      </div>
                    </div>
                    <div className="flex gap-3 pt-2">
                      <button
                        onClick={handleSave}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-white"
                      >
                        Salvar
                      </button>
                      <button
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors text-white"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                ) : (
                  <>
                    <div className="student-info">
                      <h3 className="student-name text-xl font-bold text-blue-400 mb-1">
                        {student.name}
                      </h3>
                       {/* Display Course and Entry Date */}
                      <p className="student-course text-gray-400 text-sm">
                        {student.course}
                        {student.entryDate && ( // Display entry date if available
                            <span className="ml-2 text-gray-500 text-xs">({student.entryDate})</span>
                        )}
                      </p>
                    </div>
                    <div className="status-group flex flex-wrap gap-1 mt-2">
                      {/* Render Ativo status first */}
                      {student.status.filter(tag => tag.startsWith('ativo-')).map((tag) => (
                          renderStatusTag(tag)
                      ))}
                       {/* Render Level status next */}
                       {student.status.filter(tag => tag.startsWith('level-')).map((tag) => (
                          renderStatusTag(tag)
                      ))}
                      {/* Render "Não Sabe" and "Crítico" statuses next */}
                       {student.status.filter(tag => tag.endsWith('-nao-sabe') || tag.startsWith('diff-critico')).map((tag) => (
                          renderStatusTag(tag)
                      ))}
                      {/* Render other statuses */}
                      {student.status.filter(tag => !tag.startsWith('ativo-') && !tag.startsWith('level-') && !tag.endsWith('-nao-sabe') && !tag.startsWith('diff-critico')).map((tag) => (
                          renderStatusTag(tag)
                      ))}
                    </div>
                    <div className="student-actions absolute top-3 right-3 flex gap-2">
                      <button
                        onClick={() => setIsEditing(true)}
                        className="action-btn text-gray-400 hover:text-blue-400 transition-colors"
                        title="Editar"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                      </button>
                      <button
                        onClick={() => onDelete(student.id)}
                        className="action-btn text-gray-400 hover:text-red-400 transition-colors"
                        title="Excluir"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </div>
                  </>
                )}
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-red-900 text-gray-100">
              {/* Navigation */}
              <nav className="navbar sticky top-0 z-10 flex justify-between items-center p-4 bg-black/50 backdrop-blur-md">
                {/* Container for the count circle and title */}
                <div className="flex items-center">
                    {/* Student Count Circle - Displays count of filtered students and changes color */}
                    <div className={`student-count-circle ${countCircleColorClass}`}>
                        {filteredStudents.length}
                    </div>
                    <div className="logo text-2xl font-bold text-blue-400">Plataforma AVA</div>
                </div>
                {/* Settings menu with icon and dropdown */}
                <div className="settings-menu-container relative" ref={menuRef}> {/* Add ref and class */}
                    <button
                        onClick={() => setIsMenuOpen(!isMenuOpen)}
                        className="settings-button text-gray-300 hover:text-blue-400 transition-colors focus:outline-none"
                        aria-label="Menu de Configurações"
                    >
                        {/* Settings Icon (Feather Icons) */}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-settings">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67l-.2.2c-.39.39-.66 1.11-.66 1.67V21h-3.73a1.65 1.65 0 0 0-1.65-1.65h-.79a1.65 1.65 0 0 0-1.65 1.65H3v-3.73a1.65 1.65 0 0 0-.66-1.67l-.2-.2a1.65 1.65 0 0 0 .3-1.67l-.2-.2c.39-.39 1.11-.66 1.67-.66H3v-3.73a1.65 1.65 0 0 0 1.65-1.65v-.79a1.65 1.65 0 0 0-1.65-1.65H3V3h3.73a1.65 1.65 0 0 0 1.65 1.65h.79a1.65 1.65 0 0 0 1.65-1.65H21v3.73c.56 0 1.3.27 1.67.66l.2.2a1.65 1.65 0 0 0 0 2.34l-.2.2c-.39.39-1.11.66-1.67.66z"></path>
                        </svg>
                    </button>
                    {/* Dropdown Menu */}
                    {isMenuOpen && (
                      <div className="absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-20">
                        {/* Menu Item: Configurações */}
                        <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                alert('Funcionalidade de Configurações (em desenvolvimento)'); // Placeholder action
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Configurações
                        </a>
                        {/* Menu Item: Exportar para XLSX */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                exportToXLSX(students); // Call the export function
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Exportar para XLSX
                        </a>
                        {/* Menu Item: Importar de XLSX */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                triggerImport(); // Trigger the file input click
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Importar de XLSX
                        </a>
                        {/* New Menu Item: Gestão de Materiais Didáticos */}
                         <a
                            href="https://fbiluoficial.github.io/uninta-disciplina/" // Set the href
                            target="_blank" // Open in a new tab
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Gestão de Materiais Didáticos
                        </a>
                        {/* New Menu Item: Atualizar IDs Únicos */}
                        <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={updateUniqueIds} // Call the new function
                        >
                            Atualizar IDs Únicos
                        </a>
                        {/* New Menu Item: Zerar Todos */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700"
                            onClick={clearAllStudents} // Call the clearAllStudents function
                        >
                            Zerar Todos
                        </a>
                      </div>
                    )}
                </div>
              </nav>

              {/* Hidden file input for import */}
              <input
                type="file"
                ref={fileInputRef}
                onChange={importFromXLSX}
                accept=".xlsx"
                className="hidden-file-input"
              />


              {/* Main Content */}
              <main className="container mx-auto px-4 py-8">
                {/* Filters */}
                <div className="filters flex flex-wrap gap-4 mb-8">
                  <div className="flex-grow min-w-[200px] search-input-container"> {/* Added search-input-container class */}
                    <input
                      type="text"
                      placeholder="Buscar aluno..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="search-input w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white placeholder-gray-400 pr-10" /* Added pr-10 for button space */
                    />
                    {searchTerm && ( /* Conditionally render clear button */
                        <button
                            onClick={clearSearch}
                            className="clear-button"
                            aria-label="Limpar busca"
                        >
                            &times; {/* HTML entity for 'x' */}
                        </button>
                    )}
                  </div>
                  <div className="min-w-[200px]">
                    <select
                      value={filterStatus}
                      onChange={(e) => setFilterStatus(e.target.value)}
                      className="filter-select w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white"
                    >
                      <option value="">Filtrar por status...</option>
                      <option value="orientation-video">Vídeo Tutorial</option>
                      <option value="orientation-presencial">Presencial</option>
                      <option value="device-app">App</option>
                      <option value="device-site">Site</option>
                      <option value="diff-critico">AVA - Crítico</option>
                      <option value="diff-sabe">AVA - Sabe</option>
                      <option value="diff-dicas">AVA - Dicas</option>
                      <option value="ativo-true">Ativo</option>
                      <option value="ativo-false">Inativo</option>
                      <option value="boleto-sabe">Boleto (Sabe)</option>
                      <option value="boleto-nao-sabe">Boleto (Não Sabe)</option>
                      <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                      <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                       <option value="level-veterano">Nível: Veterano</option> {/* New filter option */}
                       <option value="level-novato">Nível: Novato</option> {/* New filter option */}
                    </select>
                  </div>
                </div>

                {/* Mensagem de Resultados da Busca */}
                {searchTerm && filteredStudents.length > 0 && (
                    <p className="text-center py-4 text-blue-300 text-lg">
                        {filteredStudents.length} aluno(s) encontrado(s) para "{searchTerm}"
                    </p>
                )}

                {/* Add New Student Form */}
                {isAdding && (
                  // Adjusted padding and margin for compactness
                  <div className="form-container bg-gray-800/70 backdrop-blur-lg rounded-xl p-5 mb-6 max-w-2xl mx-auto">
                    <h1 className="text-2xl font-bold text-blue-400 mb-4">Adicionar Novo Aluno</h1>
                    {/* Adjusted spacing in the form */}
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-medium mb-1">Nome <span className="text-red-500">*</span></label> {/* Indicate required field */}
                        <input
                          type="text"
                          value={formData.name}
                          onChange={(e) => setFormData({...formData, name: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          required // Add required attribute for browser-level validation
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Curso <span className="text-red-500">*</span></label> {/* Indicate required field */}
                        <input
                          type="text"
                          value={formData.course}
                          onChange={(e) => setFormData({...formData, course: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          required // Add required attribute
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Data de Ingresso (Ex: 2025.1)</label> {/* New field */}
                        <input
                          type="text"
                          value={formData.entryDate}
                          onChange={(e) => setFormData({...formData, entryDate: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          placeholder="Ex: 2025.1"
                        />
                      </div>
                       {/* New Level Field */}
                      <div>
                        <label className="block text-sm font-medium mb-1">Nível do Aluno</label> {/* New field */}
                        <select
                          value={formData.level}
                          onChange={(e) => setFormData({...formData, level: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="level-veterano">Veterano</option>
                          <option value="level-novato">Novato</option>
                        </select>
                      </div>
                      {/* Adjusted gap in the grid */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                          <label className="block text-sm font-medium mb-1">Orientação</label>
                          <select
                            value={formData.orientation}
                            onChange={(e) => setFormData({...formData, orientation: e.target.value})}
                            className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          >
                            <option value="">Selecione...</option>
                            <option value="orientation-video">Vídeo Tutorial</option>
                            <option value="orientation-presencial">Presencial</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Dispositivo</label>
                          <select
                            value={formData.device}
                            onChange={(e) => setFormData({...formData, device: e.target.value})}
                            className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          >
                            <option value="">Selecione...</option>
                            <option value="device-app">App</option>
                            <option value="device-site">Site</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Dificuldade</label>
                          <select
                            value={formData.difficulty}
                            onChange={(e) => setFormData({...formData, difficulty: e.target.value})}
                            className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          >
                            <option value="">Selecione...</option>
                            <option value="diff-critico">AVA - Crítico</option>
                            <option value="diff-sabe">AVA - Sabe</option>
                            <option value="diff-dicas">AVA - Dicas</option>
                          </select>
                        </div>
                         {/* Status Fields */}
                         <div>
                          <label className="block text-sm font-medium mb-1">Status Ativo</label>
                          <select
                            value={formData.ativo}
                            onChange={(e) => setFormData({...formData, ativo: e.target.value})}
                            className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          >
                            <option value="">Selecione...</option>
                            <option value="ativo-true">Ativo</option>
                            <option value="ativo-false">Inativo</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Emitir Boleto</label>
                          <select
                            value={formData.boleto}
                            onChange={(e) => setFormData({...formData, boleto: e.target.value})}
                            className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          >
                            <option value="">Selecione...</option>
                            <option value="boleto-sabe">Sabe</option>
                            <option value="boleto-nao-sabe">Não Sabe</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Fórum/Discursiva</label>
                          <select
                            value={formData.forumDiscursiva}
                            onChange={(e) => setFormData({...formData, forumDiscursiva: e.target.value})}
                            className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                          >
                            <option value="">Selecione...</option>
                            <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                            <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                          </select>
                        </div>
                      </div>
                      <div className="flex gap-3 pt-2">
                        <button
                          onClick={addStudent}
                          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-white"
                        >
                          Salvar Aluno
                        </button>
                        <button
                          onClick={() => {
                            setIsAdding(false);
                            resetForm();
                          }}
                          className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors text-white"
                        >
                          Cancelar
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Student List */}
                <div className="students-container">
                  {filteredStudents.length === 0 ? (
                    <p className="text-center py-8 text-gray-400">Nenhum aluno encontrado.</p>
                  ) : (
                    filteredStudents.map(student => (
                      <StudentCard
                        key={student.id}
                        student={student}
                        onUpdate={(updatedStudent) => {
                          setStudents(students.map(s =>
                            s.id === updatedStudent.id ? updatedStudent : s
                          ));
                        }}
                        onDelete={deleteStudent}
                        isDuplicate={isDuplicateStudent(student)} // Pass the duplicate status
                      />
                    ))
                  )}
                </div>
              </main>

              {/* Floating Action Button */}
              <button
                onClick={() => setIsAdding(true)}
                className="fab fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-colors focus:outline-none"
                aria-label="Adicionar aluno"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
          );
        }

        // Render the App component into the root div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
