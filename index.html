<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uninta-aluno-Status-Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        /* Custom styles for the active/inactive circle */
        .status-tag .w-3.h-3 {
            flex-shrink: 0; /* Prevent the circle from shrinking */
        }
         /* Custom styles for the settings menu dropdown */
        .settings-menu-container {
            position: relative;
        }
        .settings-menu-container .absolute {
            position: absolute;
            /* Ensure dropdown is above other content */
            z-index: 50; /* Tailwind z-index class */
        }
         /* Hide the file input */
        .hidden-file-input {
            display: none;
        }
        /* Style for the student count circle */
        .student-count-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px; /* Adjust size as needed */
            height: 30px; /* Adjust size as needed */
            /* Background color will be set dynamically by React */
            color: white;
            border-radius: 50%;
            font-size: 0.875rem; /* text-sm */
            font-weight: bold;
            margin-right: 10px; /* Space between circle and title */
            flex-shrink: 0; /* Prevent shrinking */
            transition: background-color 0.3s ease; /* Smooth transition for color change */
        }
        /* Style for the search input container */
        .search-input-container .clear-button {
            position: absolute;
            right: 8px; /* Adjust as needed */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        .search-input-container .clear-button:hover {
            color: #fff;
        }

        /* Full page form container */
        .full-page-form-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Dark overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100; /* Ensure it's on top */
            overflow-y: auto; /* Allow scrolling for smaller screens */
            padding: 20px;
        }

        .full-page-form-container .form-content {
            background: #1a202c; /* bg-gray-900 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 2.5rem; /* p-10 */
            max-width: 800px; /* max-w-2xl */
            width: 100%;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5); /* shadow-lg */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-red-900 text-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
          // State management
          const [students, setStudents] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');
          const [filterStatus, setFilterStatus] = useState('');
          // `editingStudent` will be null for list view, {} for adding, or a student object for editing
          const [editingStudent, setEditingStudent] = useState(null);
          const [isMenuOpen, setIsMenuOpen] = useState(false); // State for menu dropdown visibility
          // New state for selected student IDs
          const [selectedStudentIds, setSelectedStudentIds] = useState(new Set());
          // New state for view mode: 'active', 'inactive', 'archived', 'all'
          const [viewMode, setViewMode] = useState('active');

          // Ref for the menu container to detect clicks outside
          const menuRef = useRef(null);
          // Ref for the hidden file input for importing
          const fileInputRef = useRef(null);


          // Load students from localStorage on initial render
          useEffect(() => {
            const savedStudents = JSON.parse(localStorage.getItem('students'));
            if (savedStudents) {
              const updatedStudents = savedStudents.map(student => {
                  const newStudent = { ...student };

                  newStudent.status = Array.isArray(newStudent.status) ? newStudent.status.filter(tag => tag && tag !== '') : [];

                  if (!newStudent.status.some(s => s.startsWith('ativo-'))) {
                      newStudent.status.push('ativo-true');
                  }

                  if (typeof newStudent.entryDate === 'undefined') {
                      newStudent.entryDate = '';
                  }
                  // Ensure lastInteractionDate exists
                  if (typeof newStudent.lastInteractionDate === 'undefined') {
                      newStudent.lastInteractionDate = '';
                  }
                  // Ensure isArchived exists and defaults to false
                  if (typeof newStudent.isArchived === 'undefined') {
                      newStudent.isArchived = false;
                  }
                  // Ensure simulado exists and defaults to empty
                  if (!newStudent.status.some(s => s.startsWith('simulado-'))) {
                      newStudent.status.push('simulado-'); // Add a default empty value
                  }
                  // Ensure motivo-inativo exists and defaults to empty
                  if (!newStudent.status.some(s => s.startsWith('motivo-inativo-'))) {
                      newStudent.status.push('motivo-inativo-'); // Add a default empty value
                  }


                  return newStudent;
              });
              setStudents(updatedStudents.filter(student => student.name && student.course));
            } else {
              // Initial sample student with all fields
              const initialStudent = {
                id: crypto.randomUUID(),
                name: "Carlos Santos",
                course: "Administração",
                entryDate: "2025.1",
                lastInteractionDate: "2025-05-20",
                isArchived: false, // New field for archiving
                status: ["orientation-video", "device-site", "diff-sabe", "ativo-true", "boleto-sabe", "forum-discursiva-sabe", "level-veterano", "simulado-sim", "motivo-inativo-"] // Added simulado-sim and motivo-inativo-
              };
              setStudents([initialStudent]);
            }
          }, []);

          // Save students to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('students', JSON.stringify(students));
          }, [students]);

            // Effect to close menu on outside click
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };

                if (isMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isMenuOpen]);


          // Filter students based on search, status filter, and view mode
          const filteredStudents = students.filter(student => {
            console.log('Calculando filteredStudents. filterStatus:', filterStatus, 'searchTerm:', searchTerm, 'viewMode:', viewMode); // Debugging log
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
            // If search term is empty, show all students for search part
            const matchesSearch = lowerCaseSearchTerm ?
                lowerCaseSearchTerm.split(/\s+/).filter(word => word.length > 0).every(word =>
                    `${student.name} ${student.course} ${student.entryDate} ${student.lastInteractionDate}`.toLowerCase().includes(word)
                ) : true;

            // Check if student matches the specific status filter (e.g., 'diff-critico')
            const matchesFilter = filterStatus ?
              student.status.includes(filterStatus) : true;

            // Check if student matches the selected view mode (active, inactive, archived, all)
            let matchesViewMode = true;
            if (viewMode === 'active') {
                matchesViewMode = student.status.includes('ativo-true') && !student.isArchived;
            } else if (viewMode === 'inactive') {
                matchesViewMode = student.status.includes('ativo-false') && !student.isArchived;
            } else if (viewMode === 'archived') {
                matchesViewMode = student.isArchived;
            } else if (viewMode === 'all') {
                matchesViewMode = true; // Show all students regardless of active/archived status
            }

            return matchesSearch && matchesFilter && matchesViewMode;
          });

          // Determine the background color class for the student count circle
          const countCircleColorClass = (searchTerm || filterStatus || viewMode !== 'active') ? 'bg-yellow-500 text-gray-900' : 'bg-blue-500';


          // Get label for status tag
          const getTagLabel = (tag) => {
            const tagMap = {
              'orientation-video': 'Vídeo Tutorial',
              'orientation-presencial': 'Presencial',
              'device-app': 'App',
              'device-site': 'Site',
              'diff-critico': 'AVA - Crítico',
              'diff-sabe': 'AVA - Sabe',
              'diff-dicas': 'AVA - Dicas',
              'ativo-true': 'Ativo',
              'ativo-false': 'Inativo',
              'boleto-sabe': 'Boleto (Sabe)',
              'boleto-nao-sabe': 'Boleto (Não Sabe)',
              'forum-discursiva-sabe': 'Fórum/Discursiva (Sabe Finalizar)',
              'forum-discursiva-nao-sabe': 'Fórum/Discursiva (Não Sabe Finalizar)',
              'level-veterano': 'Nível: Veterano',
              'level-novato': 'Nível: Novato',
              'simulado-sim': 'USA SIMULADO: SIM',
              'simulado-nao': 'USA SIMULADO: NÃO',
              'simulado-ajuda': 'USA SIMULADO: USA/REQUER AJUDA',
              'motivo-inativo-trancou': 'Motivo Inativo: Trancou',
              'motivo-inativo-desistente': 'Motivo Inativo: Desistente',
              'motivo-inativo-pendente': 'Motivo Inativo: Pendente-$',
              'motivo-inativo-finalizou': 'Motivo Inativo: Finalizou',
              'motivo-inativo-diplomado': 'Motivo Inativo: Diplomado(a)'
            };
            return tagMap[tag] || tag;
          };

           // Get tag value from label (reverse of getTagLabel)
            const getTagValue = (label) => {
                const tagMap = {
                    'Vídeo Tutorial': 'orientation-video',
                    'Presencial': 'orientation-presencial',
                    'App': 'device-app',
                    'Site': 'site',
                    'AVA - Crítico': 'diff-critico',
                    'AVA - Sabe': 'diff-sabe',
                    'AVA - Dicas': 'diff-dicas',
                    'Ativo': 'ativo-true',
                    'Inativo': 'ativo-false',
                    'Boleto (Sabe)': 'boleto-sabe',
                    'Boleto (Não Sabe)': 'boleto-nao-sabe',
                    'Fórum/Discursiva (Sabe Finalizar)': 'forum-discursiva-sabe',
                    'Fórum/Discursiva (Não Sabe Finalizar)': 'forum-discursiva-nao-sabe',
                    'Nível: Veterano': 'level-veterano',
                    'Nível: Novato': 'level-novato',
                    'USA SIMULADO: SIM': 'simulado-sim',
                    'USA SIMULADO: NÃO': 'simulado-nao',
                    'USA SIMULADO: USA/REQUER AJUDA': 'simulado-ajuda',
                    'Motivo Inativo: Trancou': 'motivo-inativo-trancou',
                    'Motivo Inativo: Desistente': 'motivo-inativo-desistente',
                    'Motivo Inativo: Pendente-$': 'motivo-inativo-pendente',
                    'Motivo Inativo: Finalizou': 'motivo-inativo-finalizou',
                    'Motivo Inativo: Diplomado(a)': 'motivo-inativo-diplomado'
                };
                return tagMap[label] || label;
            };

            // New function to get color for status tags
            const getTagColor = (tag) => {
                const colorMap = {
                    'orientation-': 'bg-green-600',
                    'device-': 'bg-indigo-600',
                    'diff-critico': 'bg-red-600',
                    'diff-sabe': 'bg-green-600',
                    'diff-dicas': 'bg-yellow-600',
                    'boleto-': 'bg-blue-600',
                    'forum-discursiva-': 'bg-purple-600',
                    'level-veterano': 'bg-orange-600',
                    'level-novato': 'bg-teal-600',
                    'simulado-sim': 'bg-lime-600',
                    'simulado-nao': 'bg-pink-600',
                    'simulado-ajuda': 'bg-yellow-600',
                    'motivo-inativo-': 'bg-gray-600',
                };

                const prefix = tag.split('-')[0] + '-';
                if (colorMap[tag]) {
                    return colorMap[tag]; // Specific tag color
                }
                return colorMap[prefix] || 'bg-gray-600'; // Default to prefix color or grey
            };


          // Delete a student
          const deleteStudent = (id) => {
            if (window.confirm('Tem certeza que deseja excluir este aluno?')) {
              setStudents(students.filter(student => student.id !== id));
              // Also remove from selection if deleted
              setSelectedStudentIds(prev => {
                  const newSet = new Set(prev);
                  newSet.delete(id);
                  return newSet;
              });
            }
          };

          // Save a student (add or update)
          const saveStudent = (studentToSave) => {
            if (studentToSave.id) {
              // Update existing student
              setStudents(students.map(s =>
                s.id === studentToSave.id ? studentToSave : s
              ));
            } else {
              // Add new student
              setStudents([...students, { ...studentToSave, id: crypto.randomUUID() }]);
            }
            setEditingStudent(null); // Go back to list view
          };

          // Toggle archive status for a student
          const handleToggleArchive = (id, newIsArchivedStatus) => {
              setStudents(prevStudents =>
                  prevStudents.map(student =>
                      student.id === id ? { ...student, isArchived: newIsArchivedStatus } : student
                  )
              );
              setSelectedStudentIds(prev => {
                  const newSet = new Set(prev);
                  newSet.delete(id); // Remove from selection if toggled archive status
                  return newSet;
              });
          };


          // Function to export student data to XLSX
          // dataToExport can be either an array of student objects (for filtered/all)
          // or a Set of student IDs (for selected)
          const exportToXLSX = (dataToExport, fileName = 'alunos.xlsx') => {
            let finalData = [];

            // Check if dataToExport is a Set (meaning it's selected IDs)
            if (dataToExport instanceof Set) {
                finalData = students.filter(student => dataToExport.has(student.id));
            } else {
                // Otherwise, assume it's an array of student objects (e.g., filteredStudents)
                finalData = dataToExport;
            }

            if (finalData.length === 0) {
                alert('Nenhum aluno para exportar.');
                return;
            }

            const worksheetData = finalData.map(student => {
              const orientation = getTagLabel(student.status.find(tag => tag.startsWith('orientation-')) || '');
              const device = getTagLabel(student.status.find(tag => tag.startsWith('device-')) || '');
              const difficulty = getTagLabel(student.status.find(tag => tag.startsWith('diff-')) || '');
              const ativo = getTagLabel(student.status.find(tag => tag.startsWith('ativo-')) || '');
              const boleto = getTagLabel(student.status.find(tag => tag.startsWith('boleto-')) || '');
              const forumDiscursiva = getTagLabel(student.status.find(tag => tag.startsWith('forum-discursiva-')) || '');
              const level = getTagLabel(student.status.find(tag => tag.startsWith('level-')) || '');
              const simulado = getTagLabel(student.status.find(tag => tag.startsWith('simulado-')) || '');
              const motivoInativo = getTagLabel(student.status.find(tag => tag.startsWith('motivo-inativo-')) || ''); // New field

              return {
                'ID': student.id,
                'Nome do Aluno': student.name,
                'Curso': student.course,
                'Data de Ingresso': student.entryDate,
                'Data Última Interação': student.lastInteractionDate,
                'Arquivado': student.isArchived ? 'Sim' : 'Não', // Include new field
                'Nível do Aluno': level,
                'Orientação': orientation,
                'Dispositivo': device,
                'Dificuldade AVA': difficulty,
                'Status Ativo': ativo,
                'Emitir Boleto': boleto,
                'Fórum/Discursiva': forumDiscursiva,
                'USA SIMULADO': simulado,
                'Motivo Inativo': motivoInativo // New column
              };
            });

            const ws = XLSX.utils.json_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Alunos");

            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const dataBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8' });

            saveAs(dataBlob, fileName);
            setSelectedStudentIds(new Set()); // Clear selection after export
          };

          // Function to import student data from XLSX
          const importFromXLSX = (event) => {
            const file = event.target.files[0];
            if (!file) {
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                const jsonStudents = XLSX.utils.sheet_to_json(worksheet);

                const importedStudents = jsonStudents.map(item => {
                    const studentId = crypto.randomUUID();

                    const statusArray = [
                        getTagValue(item['Orientação'] || ''),
                        getTagValue(item['Dispositivo'] || ''),
                        getTagValue(item['Dificuldade AVA'] || ''),
                        getTagValue(item['Status Ativo'] || ''),
                        getTagValue(item['Emitir Boleto'] || ''),
                        getTagValue(item['Fórum/Discursiva'] || ''),
                        getTagValue(item['Nível do Aluno'] || ''),
                        getTagValue(item['USA SIMULADO'] || ''),
                        getTagValue(item['Motivo Inativo'] || '') // New field
                    ].filter(tag => tag && tag !== '');

                    return {
                        id: studentId,
                        name: item['Nome do Aluno'] || 'Nome Desconhecido',
                        course: item['Curso'] || 'Curso Desconhecido',
                        entryDate: item['Data de Ingresso'] || '',
                        lastInteractionDate: item['Data Última Interação'] || '',
                        isArchived: item['Arquivado'] === 'Sim', // Read new field
                        status: statusArray
                    };
                });

                setStudents(importedStudents);
                alert('Dados importados com sucesso!');

              } catch (error) {
                console.error("Error importing file:", error);
                alert('Erro ao importar arquivo. Certifique-se de que é um arquivo XLSX válido e no formato correto.');
              } finally {
                  event.target.value = null;
              }
            };

            reader.readAsArrayBuffer(file);
          };

          // Function to trigger the hidden file input click
          const triggerImport = () => {
            fileInputRef.current.click();
          };

          // Function to clear search term
          const clearSearch = () => {
            setSearchTerm('');
          };

          // Function to clear all student data
          const clearAllStudents = () => {
            if (window.confirm('ATENÇÃO: Tem certeza que deseja APAGAR TODOS os dados de alunos? Esta ação é irreversível.')) {
              setStudents([]);
              localStorage.removeItem('students');
              alert('Todos os dados de alunos foram zerados.');
              setIsMenuOpen(false);
              setSelectedStudentIds(new Set()); // Clear selection
            }
          };

          // Function to update unique IDs for all students and clear local storage
          const updateUniqueIds = () => {
            if (window.confirm('Tem certeza que deseja atualizar os IDs de todos os alunos e limpar o cache da página? Isso pode ser útil para corrigir IDs duplicados ou inválidos e garantir que a aplicação use os dados mais recentes.')) {
              const seenIds = new Set();
              const updatedStudents = students.map(student => {
                let newId = student.id;
                if (typeof newId !== 'string' || seenIds.has(newId)) {
                  newId = crypto.randomUUID();
                }
                seenIds.add(newId);
                return { ...student, id: newId };
              });
              setStudents(updatedStudents);

              localStorage.setItem('students', JSON.stringify(updatedStudents));

              alert('IDs dos alunos atualizados e cache da página limpo com sucesso! A página será recarregada.');
              window.location.reload();
            }
          };


          // Function to check for duplicate students (same name and course)
          const isDuplicateStudent = (currentStudent) => {
            const count = students.filter(student =>
              student.name.toLowerCase() === currentStudent.name.toLowerCase() &&
              currentStudent.course.toLowerCase() === student.course.toLowerCase() &&
              student.id !== currentStudent.id // Exclude itself when checking for duplicates
            ).length;
            return count > 0; // If count is greater than 0, it means there are other duplicates
          };

          // Handle student selection
          const handleStudentSelect = (id, isChecked) => {
              setSelectedStudentIds(prev => {
                  const newSet = new Set(prev);
                  if (isChecked) {
                      newSet.add(id);
                  } else {
                      newSet.delete(id);
                  }
                  return newSet;
              });
          };

          // Clear all selected students
          const clearSelection = () => {
              setSelectedStudentIds(new Set());
              setIsMenuOpen(false); // Close menu after action
          };


          // Student card component with inline editing
          const StudentCard = ({ student, onEdit, onDelete, isDuplicate, isSelected, onSelect, onToggleArchive }) => {
            const [editingStatus, setEditingStatus] = useState(null);

            const extractStatusValue = (prefix) => {
              return student.status.find(tag => tag.startsWith(prefix)) || '';
            };

            // Handle inline status change
            const handleInlineStatusChange = (prefix, newValue) => {
                const newStatusArray = student.status.filter(tag => !tag.startsWith(prefix));
                if (newValue) {
                    newStatusArray.push(newValue);
                }

                const updatedStudent = {
                    ...student,
                    status: newStatusArray.filter(tag => tag && tag !== '')
                };
                onEdit(updatedStudent);
                setEditingStatus(null);
            };

            const renderStatusTag = (tag) => {
                const prefix = tag.split('-')[0] + '-';

                if (tag.startsWith('ativo-')) {
                    const isActive = tag === 'ativo-true';
                    const circleColor = isActive ? 'bg-green-500' : 'bg-red-500';
                    const label = isActive ? 'Ativo' : 'Inativo';

                    const toggleActiveStatus = () => {
                        const newStatusValue = isActive ? 'ativo-false' : 'ativo-true';
                        const newStatusArray = student.status.filter(s => !s.startsWith('ativo-'));
                        newStatusArray.push(newStatusValue);
                        const updatedStudent = { ...student, status: newStatusArray };
                        onEdit(updatedStudent);
                    };

                    return (
                        <span
                            key={tag}
                            className="status-tag flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-100 cursor-pointer hover:bg-gray-600 transition-colors"
                            onClick={toggleActiveStatus}
                            title={`Clique para ${isActive ? 'desativar' : 'ativar'}`}
                        >
                            <span className={`w-3 h-3 rounded-full ${circleColor}`}></span>
                            {label}
                        </span>
                    );
                }

                if (editingStatus && editingStatus.prefix === prefix) {
                    let options = [];
                    switch (prefix) {
                        case 'orientation-':
                            options = [
                                { value: 'orientation-video', label: 'Vídeo Tutorial' },
                                { value: 'orientation-presencial', label: 'Presencial' }
                            ];
                            break;
                        case 'device-':
                            options = [
                                { value: 'device-app', label: 'App' },
                                { value: 'device-site', label: 'Site' }
                            ];
                            break;
                        case 'diff-':
                            options = [
                                { value: 'diff-critico', label: 'AVA - Crítico' },
                                { value: 'diff-sabe', label: 'AVA - Sabe' },
                                { value: 'diff-dicas', label: 'AVA - Dicas' }
                            ];
                            break;
                        case 'boleto-':
                            options = [
                                { value: 'boleto-sabe', label: 'Boleto (Sabe)' },
                                { value: 'boleto-nao-sabe', label: 'Boleto (Não Sabe)' }
                            ];
                            break;
                        case 'forum-discursiva-':
                            options = [
                                { value: 'forum-discursiva-sabe', label: 'Fórum/Discursiva (Sabe Finalizar)' },
                                { value: 'forum-discursiva-nao-sabe', label: 'Fórum/Discursiva (Não Sabe Finalizar)' }
                            ];
                            break;
                        case 'level-':
                            options = [
                                { value: 'level-veterano', label: 'Nível: Veterano' },
                                { value: 'level-novato', label: 'Nível: Novato' }
                            ];
                            break;
                        case 'simulado-':
                            options = [
                                { value: 'simulado-sim', label: 'SIM' },
                                { value: 'simulado-nao', label: 'NÃO' },
                                { value: 'simulado-ajuda', label: 'USA/REQUER AJUDA' }
                            ];
                            break;
                        case 'motivo-inativo-':
                            options = [
                                { value: 'motivo-inativo-trancou', label: 'Trancou' },
                                { value: 'motivo-inativo-desistente', label: 'Desistente' },
                                { value: 'motivo-inativo-pendente', label: 'Pendente-$' },
                                { value: 'motivo-inativo-finalizou', label: 'Finalizou' },
                                { value: 'motivo-inativo-diplomado', label: 'Diplomado(a)' }
                            ];
                            break;
                        default:
                            options = [];
                    }

                    return (
                         <select
                            key={tag}
                            value={editingStatus.currentValue}
                            onChange={(e) => handleInlineStatusChange(prefix, e.target.value)}
                            onBlur={() => setEditingStatus(null)}
                            className="px-2 py-1 text-sm bg-gray-700 rounded-lg border border-gray-600 text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                            autoFocus
                         >
                            <option value="">Selecione...</option>
                            {options.map(option => (
                                <option key={option.value} value={option.value}>{option.label}</option>
                            ))}
                         </select>
                    );
                } else {
                    return (
                        <span
                            key={tag}
                            className={`status-tag px-3 py-1 rounded-full text-sm font-medium cursor-pointer hover:opacity-80 transition-opacity ${getTagColor(tag)}`}
                            onClick={() => setEditingStatus({ prefix: prefix, currentValue: tag })}
                        >
                            {getTagLabel(tag)}
                        </span>
                    );
                }
            };


            const isInactive = student.status.includes('ativo-false');
            const motivoInativoTag = student.status.find(tag => tag.startsWith('motivo-inativo-'));

            return (
              // Added flex and items-center to align checkbox
              <div className={`student-card bg-gray-800/70 backdrop-blur-lg rounded-xl p-4 mb-4 relative flex items-start gap-3 ${student.isArchived ? 'opacity-70 border-purple-500' : ''} ${isDuplicate ? 'border-2 border-red-500' : ''}`}>
                {student.isArchived && (
                    <span className="absolute top-0 left-0 bg-purple-600 text-white text-xs px-2 py-1 rounded-br-lg z-10">Arquivado</span>
                )}
                <input
                    type="checkbox"
                    checked={isSelected}
                    onChange={(e) => onSelect(student.id, e.target.checked)}
                    className="mt-1 w-5 h-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                />
                <div className="flex-grow"> {/* This div wraps the student info and status tags */}
                  <div className="student-info">
                    <h3 className="student-name text-xl font-bold text-blue-400 mb-1">
                      {student.name}
                    </h3>
                    <p className="student-course text-gray-400 text-sm">
                      {student.course}
                      {student.entryDate && ( // Display entry date if available
                          <span className="ml-2 text-gray-500 text-xs">({student.entryDate})</span>
                      )}
                    </p>
                    {student.lastInteractionDate && ( // Display last interaction date if available
                        <p className="text-gray-500 text-xs mt-1">Última Interação: {student.lastInteractionDate}</p>
                    )}
                  </div>
                  <div className="status-group flex flex-wrap gap-1 mt-2">
                    {/* Always render 'ativo-' tag */}
                    {student.status.filter(tag => tag.startsWith('ativo-')).map((tag) => (
                        renderStatusTag(tag)
                    ))}

                    {/* Render 'motivo-inativo-' if student is inactive or if a reason is selected */}
                    {isInactive && (motivoInativoTag && motivoInativoTag !== 'motivo-inativo-' ? renderStatusTag(motivoInativoTag) : renderStatusTag('motivo-inativo-'))}

                    {/* Render other tags ONLY if student is active */}
                    {!isInactive && (
                        <>
                            {student.status.filter(tag => tag.startsWith('level-')).map((tag) => (
                                renderStatusTag(tag)
                            ))}
                            {student.status.filter(tag => tag.endsWith('-nao-sabe') || tag.startsWith('diff-critico')).map((tag) => (
                                renderStatusTag(tag)
                            ))}
                            {student.status.filter(tag => tag.startsWith('simulado-') && tag !== 'simulado-').map((tag) => (
                                renderStatusTag(tag)
                            ))}
                            {student.status.filter(tag => !tag.startsWith('ativo-') && !tag.startsWith('level-') && !tag.endsWith('-nao-sabe') && !tag.startsWith('diff-critico') && !tag.startsWith('simulado-') && !tag.startsWith('motivo-inativo-')).map((tag) => (
                                renderStatusTag(tag)
                            ))}
                        </>
                    )}
                  </div>
                </div>
                <div className="student-actions absolute top-3 right-3 flex gap-2">
                  <button
                    onClick={() => {
                        console.log("Botão Editar clicado para aluno:", student.id);
                        onEdit(student); // Pass the entire student object for editing
                    }}
                    className="action-btn text-gray-400 hover:text-blue-400 transition-colors"
                    title="Editar"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button
                    onClick={() => onToggleArchive(student.id, !student.isArchived)}
                    className="action-btn text-gray-400 hover:text-purple-400 transition-colors"
                    title={student.isArchived ? "Desarquivar" : "Arquivar"}
                  >
                      {student.isArchived ? (
                          // Icon for unarchive (e.g., folder open)
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                              <path d="M12 11v6"></path>
                              <path d="M9 14h6"></path>
                          </svg>
                      ) : (
                          // Icon for archive (e.g., folder with minus)
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                              <line x1="9" y1="14" x2="15" y2="14"></line>
                          </svg>
                      )}
                  </button>
                  <button
                    onClick={() => onDelete(student.id)}
                    className="action-btn text-gray-400 hover:text-red-400 transition-colors"
                    title="Excluir"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                  </button>
                </div>
              </div>
            );
          };

          // New component for Add/Edit Student Form
          const AddEditStudentForm = ({ studentToEdit, onSave, onCancel, getTagValue }) => {
            const [formData, setFormData] = useState({
              name: '',
              course: '',
              entryDate: '',
              lastInteractionDate: '',
              isArchived: false, // New field
              level: '',
              orientation: '',
              device: '',
              difficulty: '',
              ativo: 'ativo-true',
              boleto: '',
              forumDiscursiva: '',
              simulado: '', // New field
              motivoInativo: '' // New field
            });

            useEffect(() => {
              console.log("Rendering AddEditStudentForm, studentToEdit:", studentToEdit);
              if (studentToEdit && studentToEdit.id) { // Editing existing student
                const extractStatus = (prefix) => studentToEdit.status.find(tag => tag.startsWith(prefix)) || '';
                setFormData({
                  name: studentToEdit.name,
                  course: studentToEdit.course,
                  entryDate: studentToEdit.entryDate,
                  lastInteractionDate: studentToEdit.lastInteractionDate,
                  isArchived: studentToEdit.isArchived || false, // Populate new field
                  level: extractStatus('level-'),
                  orientation: extractStatus('orientation-'),
                  device: extractStatus('device-'),
                  difficulty: extractStatus('diff-'),
                  ativo: extractStatus('ativo-'),
                  boleto: extractStatus('boleto-'),
                  forumDiscursiva: extractStatus('forum-discursiva-'),
                  simulado: extractStatus('simulado-'),
                  motivoInativo: extractStatus('motivo-inativo-') // Populate new field
                });
              } else { // Adding new student or no student to edit
                setFormData({
                  name: '',
                  course: '',
                  entryDate: '',
                  lastInteractionDate: '',
                  isArchived: false, // Reset for new student
                  level: '',
                  orientation: '',
                  device: '',
                  difficulty: '',
                  ativo: 'ativo-true',
                  boleto: '',
                  forumDiscursiva: '',
                  simulado: '',
                  motivoInativo: '' // Reset for new student
                });
              }
            }, [studentToEdit]);

            const handleSubmit = () => {
              if (!formData.name || !formData.course) {
                alert('Por favor, preencha o Nome do Aluno e o Curso.');
                return;
              }

              const newStatus = [
                  formData.orientation,
                  formData.device,
                  formData.difficulty,
                  formData.ativo || 'ativo-true',
                  formData.boleto,
                  formData.forumDiscursiva,
                  formData.level,
                  formData.simulado,
                  formData.motivoInativo // Include new field
              ].filter(tag => tag && tag !== '');

              const studentData = {
                id: studentToEdit ? studentToEdit.id : undefined, // Keep ID if editing, undefined if new
                name: formData.name,
                course: formData.course,
                entryDate: formData.entryDate,
                lastInteractionDate: formData.lastInteractionDate,
                isArchived: formData.isArchived, // Include new field
                status: newStatus
              };
              onSave(studentData);
            };

            return (
              <div className="full-page-form-container">
                <div className="form-content">
                  <h1 className="text-2xl font-bold text-blue-400 mb-4">
                    {studentToEdit && studentToEdit.id ? 'Editar Aluno' : 'Adicionar Novo Aluno'}
                  </h1>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">Nome <span className="text-red-500">*</span></label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Curso <span className="text-red-500">*</span></label>
                      <input
                        type="text"
                        value={formData.course}
                        onChange={(e) => setFormData({...formData, course: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Data de Ingresso (Ex: 2025.1)</label>
                      <input
                        type="text"
                        value={formData.entryDate}
                        onChange={(e) => setFormData({...formData, entryDate: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        placeholder="Ex: 2025.1"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Última Interação (AAAA-MM-DD)</label>
                      <input
                        type="date"
                        value={formData.lastInteractionDate}
                        onChange={(e) => setFormData({...formData, lastInteractionDate: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Nível do Aluno</label>
                      <select
                        value={formData.level}
                        onChange={(e) => setFormData({...formData, level: e.target.value})}
                        className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                      >
                        <option value="">Selecione...</option>
                        <option value="level-veterano">Veterano</option>
                        <option value="level-novato">Novato</option>
                      </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div>
                        <label className="block text-sm font-medium mb-1">Orientação</label>
                        <select
                          value={formData.orientation}
                          onChange={(e) => setFormData({...formData, orientation: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="orientation-video">Vídeo Tutorial</option>
                          <option value="orientation-presencial">Presencial</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Dispositivo</label>
                        <select
                          value={formData.device}
                          onChange={(e) => setFormData({...formData, device: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="device-app">App</option>
                          <option value="device-site">Site</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Dificuldade</label>
                        <select
                          value={formData.difficulty}
                          onChange={(e) => setFormData({...formData, difficulty: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="diff-critico">AVA - Crítico</option>
                          <option value="diff-sabe">AVA - Sabe</option>
                          <option value="diff-dicas">AVA - Dicas</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Status Ativo</label>
                        <select
                          value={formData.ativo}
                          onChange={(e) => setFormData({...formData, ativo: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="ativo-true">Ativo</option>
                          <option value="ativo-false">Inativo</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Emitir Boleto</label>
                        <select
                          value={formData.boleto}
                          onChange={(e) => setFormData({...formData, boleto: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="boleto-sabe">Sabe</option>
                          <option value="boleto-nao-sabe">Não Sabe</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Fórum/Discursiva</label>
                        <select
                          value={formData.forumDiscursiva}
                          onChange={(e) => setFormData({...formData, forumDiscursiva: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                          <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                        </select>
                      </div>
                      <div> {/* New dropdown for USA SIMULADO */}
                        <label className="block text-sm font-medium mb-1">USA SIMULADO</label>
                        <select
                          value={formData.simulado}
                          onChange={(e) => setFormData({...formData, simulado: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="simulado-sim">SIM</option>
                          <option value="simulado-nao">NÃO</option>
                          <option value="simulado-ajuda">USA/REQUER AJUDA</option>
                        </select>
                      </div>
                      <div> {/* New dropdown for Motivo Inativo */}
                        <label className="block text-sm font-medium mb-1">Motivo Inativo</label>
                        <select
                          value={formData.motivoInativo}
                          onChange={(e) => setFormData({...formData, motivoInativo: e.target.value})}
                          className="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 text-white"
                        >
                          <option value="">Selecione...</option>
                          <option value="motivo-inativo-trancou">Trancou</option>
                          <option value="motivo-inativo-desistente">Desistente</option>
                          <option value="motivo-inativo-pendente">Pendente-$</option>
                          <option value="motivo-inativo-finalizou">Finalizou</option>
                          <option value="motivo-inativo-diplomado">Diplomado(a)</option>
                        </select>
                      </div>
                    </div>
                    <div className="flex items-center gap-2 mt-4"> {/* New checkbox for archived status */}
                        <input
                            type="checkbox"
                            id="isArchived"
                            checked={formData.isArchived}
                            onChange={(e) => setFormData({...formData, isArchived: e.target.checked})}
                            className="w-5 h-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                        />
                        <label htmlFor="isArchived" className="text-sm font-medium text-gray-300">Arquivado</label>
                    </div>
                    <div className="flex gap-3 pt-2">
                      <button
                        onClick={handleSubmit}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-white"
                      >
                        Salvar
                      </button>
                      <button
                        onClick={onCancel}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors text-white"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };


          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-red-900 text-gray-100">
              {/* Debugging log for editingStudent state */}
              {console.log('App renderizado, editingStudent:', editingStudent)}
              {/* Navigation */}
              <nav className="navbar sticky top-0 z-10 flex justify-between items-center p-4 bg-black/50 backdrop-blur-md">
                {/* Container for the count circle and title */}
                <div className="flex items-center">
                    {/* Student Count Circle - Displays count of filtered students and changes color */}
                    <div className={`student-count-circle ${countCircleColorClass}`}>
                        {filteredStudents.length}
                    </div>
                    <div className="logo text-2xl font-bold text-blue-400">Plataforma AVA</div>
                    {/* New tag for Relatório-Adm-Uninta */}
                    <a
                        href="https://uniesbra4jf.github.io/relatorio-Uninta/"
                        target="_blank"
                        className="ml-4 px-3 py-1 rounded-full text-sm font-bold bg-red-700 text-white hover:bg-red-600 transition-colors md:block"
                        title="Abrir Relatório-Adm-Uninta em uma nova aba"
                    >
                        Relatório-Adm-Uninta
                    </a>
                    
                     <a
                        href="https://uniesbra4jf.github.io/Manual-Adm-UNINTA/"
                        target="_blank"
                        className="ml-4 px-3 py-1 rounded-full text-sm font-bold bg-blu-700 text-white hover:bg-red-600 transition-colors md:block"
                        title="Abrir Relatório-Adm-Uninta em uma nova aba"
                    >
                        Manual-Adm-UNINTA
                    </a>
                    
                </div>
                {/* Settings menu with icon and dropdown */}
                <div className="settings-menu-container relative" ref={menuRef}> {/* Add ref and class */}
                    <button
                        onClick={() => setIsMenuOpen(!isMenuOpen)}
                        className="settings-button text-gray-300 hover:text-blue-400 transition-colors focus:outline-none"
                        aria-label="Menu de Configurações"
                    >
                        {/* Settings Icon (Feather Icons) */}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-settings">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67l-.2.2c-.39.39-.66 1.11-.66 1.67V21h-3.73a1.65 1.65 0 0 0-1.65-1.65h-.79a1.65 1.65 0 0 0-1.65 1.65H3v-3.73a1.65 1.65 0 0 0-.66-1.67l-.2-.2a1.65 1.65 0 0 0 .3-1.67l-.2-.2c.39-.39 1.11-.66 1.67-.66H3v-3.73a1.65 1.65 0 0 0 1.65-1.65v-.79a1.65 1.65 0 0 0-1.65-1.65H3V3h3.73a1.65 1.65 0 0 0 1.65 1.65h.79a1.65 1.65 0 0 0 1.65-1.65H21v3.73c.56 0 1.3.27 1.67.66l.2.2a1.65 1.65 0 0 0 0 2.34l-.2.2c-.39.39-1.11.66-1.67.66z"></path>
                        </svg>
                    </button>
                    {/* Dropdown Menu */}
                    {isMenuOpen && (
                      <div className="absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-20">
                        {/* Menu Item: Configurações */}
                        <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                alert('Funcionalidade de Configurações (em desenvolvimento)'); // Placeholder action
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Configurações
                        </a>
                        {/* Menu Item: Exportar para XLSX (Todos) */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                // Export the currently filtered students
                                exportToXLSX(filteredStudents, 'alunos_filtrados.xlsx');
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Exportar para XLSX (Filtrados)
                        </a>
                        {/* New Menu Item: Exportar Selecionados para XLSX */}
                        <a
                            href="#"
                            className={`block px-4 py-2 text-sm ${selectedStudentIds.size > 0 ? 'text-blue-300 hover:bg-gray-700' : 'text-gray-500 cursor-not-allowed'}`}
                            onClick={(e) => {
                                if (selectedStudentIds.size > 0) {
                                    exportToXLSX(selectedStudentIds, 'alunos_selecionados.xlsx'); // Export only selected
                                } else {
                                    alert('Nenhum aluno selecionado para exportar.');
                                }
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Exportar Selecionados para XLSX
                        </a>
                        {/* Menu Item: Importar de XLSX */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                triggerImport(); // Trigger the file input click
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            Importar de XLSX
                        </a>
                        {/* New Menu Item: Gestão de Materiais Didáticos */}
                         <a
                            href="https://fbiluoficial.github.io/uninta-disciplina/" // Set the href
                            target="_blank" // Open in a new tab
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={() => {
                                setIsMenuOpen(false); // Close menu on click
                            }}
                        >
                            ✨Gestão de Materiais Didáticos
                        </a>

                          
                        {/* New Menu Item: Atualizar IDs Únicos */}
                          
                        {/* New Menu Item: Atualizar IDs Únicos */}
                        <a
                            href="#"
                            className="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"
                            onClick={updateUniqueIds} // Call the new function
                        >
                            Atualizar IDs Únicos
                        </a>
                        {/* New Menu Item: Limpar Seleção */}
                        <a
                            href="#"
                            className={`block px-4 py-2 text-sm ${selectedStudentIds.size > 0 ? 'text-yellow-300 hover:bg-gray-700' : 'text-gray-500 cursor-not-allowed'}`}
                            onClick={(e) => {
                                if (selectedStudentIds.size > 0) {
                                    clearSelection();
                                } else {
                                    alert('Nenhum aluno selecionado para limpar.');
                                }
                            }}
                        >
                            Limpar Seleção ({selectedStudentIds.size})
                        </a>
                        {/* New Menu Item: Zerar Todos */}
                         <a
                            href="#"
                            className="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700"
                            onClick={clearAllStudents} // Call the clearAllStudents function
                        >
                            Zerar Todos
                        </a>
                      </div>
                    )}
                </div>
              </nav>

              {/* Hidden file input for import */}
              <input
                type="file"
                ref={fileInputRef}
                onChange={importFromXLSX}
                accept=".xlsx"
                className="hidden-file-input"
              />


              {/* Main Content */}
              <main className="container mx-auto px-4 py-8">
                {/* Filters */}
                <div className="filters flex flex-wrap gap-4 mb-8">
                  <div className="flex-grow min-w-[200px] search-input-container"> {/* Added search-input-container class */}
                    <input
                      type="text"
                      placeholder="Buscar aluno..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="search-input w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white placeholder-gray-400 pr-10" /* Added pr-10 for button space */
                    />
                    {searchTerm && ( /* Conditionally render clear button */
                        <button
                            onClick={clearSearch}
                            className="clear-button"
                            aria-label="Limpar busca"
                        >
                            &times; {/* HTML entity for 'x' */}
                        </button>
                    )}
                  </div>
                  <div className="min-w-[200px]">
                    <select
                      value={filterStatus}
                      onChange={(e) => {
                          console.log('Filtro de status alterado para:', e.target.value); // Debugging log
                          setFilterStatus(e.target.value);
                      }}
                      className="filter-select w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white"
                    >
                      <option value="">Filtrar por status...</option>
                      <option value="orientation-video">Vídeo Tutorial</option>
                      <option value="orientation-presencial">Presencial</option>
                      <option value="device-app">App</option>
                      <option value="device-site">Site</option>
                      <option value="diff-critico">AVA - Crítico</option>
                      <option value="diff-sabe">AVA - Sabe</option>
                      <option value="diff-dicas">AVA - Dicas</option>
                      <option value="ativo-true">Ativo</option>
                      <option value="ativo-false">Inativo</option>
                      <option value="boleto-sabe">Boleto (Sabe)</option>
                      <option value="boleto-nao-sabe">Boleto (Não Sabe)</option>
                      <option value="forum-discursiva-sabe">Fórum/Discursiva (Sabe Finalizar)</option>
                      <option value="forum-discursiva-nao-sabe">Fórum/Discursiva (Não Sabe Finalizar)</option>
                       <option value="level-veterano">Nível: Veterano</option>
                       <option value="level-novato">Nível: Novato</option>
                       <option value="simulado-sim">USA SIMULADO: SIM</option>
                       <option value="simulado-nao">USA SIMULADO: NÃO</option>
                       <option value="simulado-ajuda">USA SIMULADO: USA/REQUER AJUDA</option>
                       <option value="motivo-inativo-trancou">Motivo Inativo: Trancou</option>
                       <option value="motivo-inativo-desistente">Motivo Inativo: Desistente</option>
                       <option value="motivo-inativo-pendente">Motivo Inativo: Pendente-$</option>
                       <option value="motivo-inativo-finalizou">Motivo Inativo: Finalizou</option>
                       <option value="motivo-inativo-diplomado">Motivo Inativo: Diplomado(a)</option>
                    </select>
                  </div>
                  {/* New dropdown for view mode */}
                  <div className="min-w-[200px]">
                    <select
                      value={viewMode}
                      onChange={(e) => setViewMode(e.target.value)}
                      className="filter-select w-full px-4 py-2 bg-gray-800/50 rounded-lg border border-gray-700 text-white"
                    >
                      <option value="active">Mostrar Ativos</option>
                      <option value="inactive">Mostrar Inativos</option>
                      <option value="archived">Mostrar Arquivados</option>
                      <option value="all">Mostrar Todos</option>
                    </select>
                  </div>
                </div>

                {/* Student List */}
                <div className="students-container">
                  {filteredStudents.length > 0 ? (
                    filteredStudents.map(student => (
                      <StudentCard
                        key={student.id}
                        student={student}
                        onEdit={setEditingStudent}
                        onDelete={deleteStudent}
                        isDuplicate={isDuplicateStudent(student)}
                        isSelected={selectedStudentIds.has(student.id)}
                        onSelect={handleStudentSelect}
                        onToggleArchive={handleToggleArchive} // Pass the new toggle archive function
                      />
                    ))
                  ) : (
                    <p className="text-center py-8 text-gray-400">Nenhum aluno encontrado com os filtros aplicados.</p>
                  )}
                </div>
              </main>

              {/* Add/Edit Student Form (Full Page) */}
              {editingStudent !== null && (
                <AddEditStudentForm
                  studentToEdit={editingStudent}
                  onSave={saveStudent}
                  onCancel={() => setEditingStudent(null)}
                  getTagValue={getTagValue}
                />
              )}

              {/* Floating Action Button */}
              {editingStudent === null && ( // Only show FAB if not adding/editing
                <button
                  onClick={() => {
                      console.log("FAB clicado, definindo editingStudent para objeto vazio");
                      setEditingStudent({}); // Set to empty object for new student
                  }}
                  className="fab fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-colors focus:outline-none z-50"
                  aria-label="Adicionar aluno"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              )}
            </div>
          );
        }

        // Render the App component into the root div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
